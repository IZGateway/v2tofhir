<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>IzQuery.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">HL7 Version 2 to FHIR Conversion</a> &gt; <a href="index.source.html" class="el_package">gov.cdc.izgw.v2tofhir.utils</a> &gt; <span class="el_source">IzQuery.java</span></div><h1>IzQuery.java</h1><pre class="source lang-java linenums">package gov.cdc.izgw.v2tofhir.utils;

import java.util.List;

import org.hl7.fhir.r4.model.Immunization;
import org.hl7.fhir.r4.model.Patient;
import ca.uhn.fhir.rest.param.DateParam;
import ca.uhn.fhir.rest.param.NumberParam;
import ca.uhn.fhir.rest.param.ReferenceParam;
import ca.uhn.fhir.rest.param.TokenParam;
import ca.uhn.hl7v2.HL7Exception;
import ca.uhn.hl7v2.model.v251.datatype.CX;
import ca.uhn.hl7v2.model.v251.datatype.ID;
import ca.uhn.hl7v2.model.v251.datatype.IS;
import ca.uhn.hl7v2.model.v251.datatype.NM;
import ca.uhn.hl7v2.model.v251.datatype.ST;
import ca.uhn.hl7v2.model.v251.datatype.TS;
import ca.uhn.hl7v2.model.v251.datatype.XAD;
import ca.uhn.hl7v2.model.v251.datatype.XPN;
import ca.uhn.hl7v2.model.v251.datatype.XTN;
import ca.uhn.hl7v2.model.v251.segment.QPD;
import ca.uhn.hl7v2.model.v251.segment.RCP;
import lombok.Data;

/**
 * A structure to manage query parameters.
 * @author Audacious Inquiry
 */
@Data
public class IzQuery {
	/** The number of results to return */
	public static final String COUNT = &quot;_count&quot;;
	/** Code used for an Immunization History Request */
	public static final String HISTORY = &quot;Z34&quot;;
	/** Search parameter for Patient Address Lines */
	public static final String PATIENT_ADDRESS = Immunization.SP_PATIENT + &quot;.&quot; + Patient.SP_ADDRESS;
	/** Search parameter for Patient Address City */
	public static final String PATIENT_ADDRESS_CITY = Immunization.SP_PATIENT + &quot;.&quot; + Patient.SP_ADDRESS_CITY;
	/** Search parameter for Patient Address Country */
	public static final String PATIENT_ADDRESS_COUNTRY = Immunization.SP_PATIENT + &quot;.&quot; + Patient.SP_ADDRESS_COUNTRY;
	/** Search parameter for Patient Address Postal Code */
	public static final String PATIENT_ADDRESS_POSTAL = Immunization.SP_PATIENT + &quot;.&quot; + Patient.SP_ADDRESS_POSTALCODE;
	/** Search parameter for Patient Address State */
	public static final String PATIENT_ADDRESS_STATE = Immunization.SP_PATIENT + &quot;.&quot; + Patient.SP_ADDRESS_STATE;
	/** Search parameter for Birth Date */
	public static final String PATIENT_BIRTHDATE = Immunization.SP_PATIENT + &quot;.&quot; + Patient.SP_BIRTHDATE;
	/** Search parameter for Gender */
	public static final String PATIENT_GENDER = Immunization.SP_PATIENT + &quot;.&quot; + Patient.SP_GENDER;
	/** Search parameter for Patient Phone */
	public static final String PATIENT_HOMEPHONE = Immunization.SP_PATIENT + &quot;.&quot; + Patient.SP_PHONE;

	/** Search parameter for PatientList */
	public static final String PATIENT_LIST = Immunization.SP_PATIENT + &quot;.&quot; + Patient.SP_IDENTIFIER;
	/** Search parameter for Mothers Maiden Name Extension */
	public static final String PATIENT_MOTHERS_MAIDEN_NAME = Immunization.SP_PATIENT + &quot;.mothers-maiden-name&quot;;
	/** Search parameter for Patient Multiple Birth Indicator */
	public static final String PATIENT_MULTIPLE_BIRTH_INDICATOR  = Immunization.SP_PATIENT + &quot;.multipleBirth-indicator&quot;;
	/** Search parameter for Patient Multiple Birth Order */
	public static final String PATIENT_MULTIPLE_BIRTH_ORDER = Immunization.SP_PATIENT + &quot;.multipleBirth-order&quot;;
	/** Search parameter for PatientName Family Part */
	public static final String PATIENT_NAME_FAMILY = Immunization.SP_PATIENT + &quot;.&quot; + Patient.SP_FAMILY;
	/** Search parameter for PatientName Given and Middle Part */
	public static final String PATIENT_NAME_GIVEN = Immunization.SP_PATIENT + &quot;.&quot; + Patient.SP_GIVEN;
	/** Search parameter for PatientName Suffix Part */
	public static final String PATIENT_NAME_SUFFIX = Immunization.SP_PATIENT + &quot;.suffix&quot;;
	/** Search parameter for PatientName Use Part */
	public static final String PATIENT_NAME_USE = Immunization.SP_PATIENT + &quot;.name-use&quot;;
	/** Code used for an Immunization Evaluated History and Recommendation Request */
	public static final String RECOMMENDATION = &quot;Z44&quot;;
	private static final String CANNOT_REPEAT = &quot;Cannot repeat query parameter: &quot;;

	/** The patient address */
	private final XAD address;
	/** The patient birth date */
	private final TS birthDate;
	/** The patient gender */
	private final IS gender;
	/** The mothers maiden name */
	private final XPN maiden;
	/** The name */
	private final XPN name;
	private final QPD qpd;
	/** The patient home phone */
	private final ST telephone;
	/** Max number of records to return */
<span class="fc" id="L86">	int count = 5;</span>
	/** If an id was found */
<span class="fc" id="L88">	boolean hasId = false;</span>

	/**
	 * Create a new Query for an Immunization or ImmunizationRecommendation
	 * @param qpd	The QPD to create
	 * @throws HL7Exception
	 */
<span class="fc" id="L95">	public IzQuery(QPD qpd) throws HL7Exception {</span>
<span class="fc" id="L96">		this.qpd = qpd;</span>
<span class="fc" id="L97">		name = QBPUtils.getField(qpd, 4, XPN.class);</span>
<span class="fc" id="L98">		maiden = QBPUtils.getField(qpd, 5, XPN.class);</span>
<span class="fc" id="L99">		birthDate = QBPUtils.getField(qpd, 6, TS.class);</span>
<span class="fc" id="L100">		gender = QBPUtils.getField(qpd, 7, IS.class);</span>
<span class="fc" id="L101">		address = QBPUtils.getField(qpd, 8, XAD.class);</span>
<span class="fc" id="L102">		telephone = QBPUtils.getField(qpd, 9, XTN.class).getTelephoneNumber();</span>
<span class="fc" id="L103">	}</span>
	
	/**
	 * Add a given search parameter to the QPD segment.
	 * @param fhirParamName	The FHIR parameter name
	 * @param params	The list of parameters.
	 * @throws HL7Exception	If an error occurs.
	 */
	public void addParameter(	// NOSONAR: Giant switch is acceptable
		String fhirParamName, List&lt;String&gt; params
	) throws HL7Exception {
<span class="pc bpc" id="L114" title="2 of 4 branches missed.">		if (fhirParamName == null || fhirParamName.isEmpty()) {</span>
<span class="nc" id="L115">			return;</span>
		}
<span class="fc bfc" id="L117" title="All 2 branches covered.">		for (String param: params) {</span>
<span class="pc bpc" id="L118" title="4 of 6 branches missed.">			if (fhirParamName.length() &gt; 0 &amp;&amp; fhirParamName.charAt(0) == '_' &amp;&amp; !COUNT.equals(fhirParamName)) {</span>
				// Ignore FHIR special search parameters.
<span class="nc" id="L120">				continue;</span>
			}
<span class="pc bpc" id="L122" title="10 of 20 branches missed.">			switch (fhirParamName) {</span>
			case COUNT:
<span class="nc" id="L124">				setCount(param);</span>
<span class="nc" id="L125">				break;</span>
			
			case Immunization.SP_PATIENT:
<span class="nc" id="L128">				ReferenceParam refParam = new ReferenceParam();</span>
<span class="nc" id="L129">				refParam.setValueAsQueryToken(null, Immunization.SP_PATIENT, null, param);</span>
<span class="nc" id="L130">				String ident = FhirIdCodec.decode(refParam.getIdPart());</span>
<span class="nc" id="L131">				setPatientList(fhirParamName, ident);</span>
<span class="nc" id="L132">				break;</span>
			case PATIENT_LIST: //	QPD-3	PatientList (can repeat)
<span class="fc" id="L134">				setPatientList(fhirParamName, param);</span>
<span class="fc" id="L135">				break;</span>
				
			case PATIENT_NAME_FAMILY: //	QPD-4.1	PatientName
<span class="fc" id="L138">				setPatientFamilyName(param);</span>
<span class="fc" id="L139">				break;</span>
			case PATIENT_NAME_GIVEN: //	QPD-4.2	and QPD-4.3	PatientName
<span class="fc" id="L141">				setPatientGivenName(param);</span>
<span class="fc" id="L142">				break;</span>
			case PATIENT_NAME_SUFFIX: //	QPD-4.4	PatientName
<span class="nc" id="L144">				setPatientNameSuffix(param);</span>
<span class="nc" id="L145">				break;</span>

			case PATIENT_MOTHERS_MAIDEN_NAME: //	QPD-5	PatientMotherMaidenName
<span class="fc" id="L148">				setMothersMaidenName(param);</span>
<span class="fc" id="L149">				break;</span>
			// Given and Suffix won't be used in V2 searches on mother's maiden name, but it allows
			// the v2tofhir components to round trip.
			case PATIENT_MOTHERS_MAIDEN_NAME + &quot;-given&quot;:
<span class="fc" id="L153">				setMothersMaidenGivenName(param);</span>
<span class="fc" id="L154">				break;</span>
			case PATIENT_MOTHERS_MAIDEN_NAME + &quot;-suffix&quot;:
<span class="nc" id="L156">				setMothersMaidenNameSuffix(param);</span>
<span class="nc" id="L157">				break;</span>
			case PATIENT_BIRTHDATE: //	QPD-6	PatientDateOfBirth
<span class="fc" id="L159">				setPatientBirthDate(fhirParamName, param);</span>
<span class="fc" id="L160">				break;</span>
				
			case PATIENT_GENDER: //	QPD-7	PatientSex
<span class="fc" id="L163">				setPatientGender(fhirParamName, param);</span>
<span class="fc" id="L164">				break;</span>
			
			case PATIENT_ADDRESS: //	QPD-8-1 and QPD-8-2	PatientAddress
<span class="fc" id="L167">				setPatientAddress(param);</span>
<span class="fc" id="L168">				break;</span>
			case PATIENT_ADDRESS_CITY: //	QPD-8-3	PatientAddress
<span class="fc" id="L170">				setPatientSuffixCity(param);</span>
<span class="fc" id="L171">				break;</span>
			case PATIENT_ADDRESS_STATE: //	QPD-8-4	PatientAddress
<span class="fc" id="L173">				setPatientAddressState(param);</span>
<span class="fc" id="L174">				break;</span>
			case PATIENT_ADDRESS_POSTAL: //	QPD-8-5	PatientAddress
<span class="nc" id="L176">				setPatientAddressPostal(param);</span>
<span class="nc" id="L177">				break;</span>
			case PATIENT_ADDRESS_COUNTRY: //	QPD-8-5	PatientAddress
<span class="nc" id="L179">				setPatientAddressCountry(param);</span>
<span class="nc" id="L180">				break;</span>
			
			case PATIENT_HOMEPHONE: //	QPD-9	PatientHomePhone
<span class="nc" id="L183">				setPatientPhone(param);</span>
<span class="nc" id="L184">				break;</span>
			
			case PATIENT_MULTIPLE_BIRTH_INDICATOR: //	QPD-10	PatientMultipleBirthIndicator
<span class="nc" id="L187">				setMultipleBirthIndicator(param);</span>
<span class="nc" id="L188">				break;</span>
			
			case PATIENT_MULTIPLE_BIRTH_ORDER: //	QPD-11	PatientBirthOrder
<span class="nc" id="L191">				setMultipleBirthOrder(param);</span>
<span class="nc" id="L192">				break;</span>
			
			default:
<span class="nc" id="L195">				throw new IllegalArgumentException(&quot;Invalid query parameter: &quot; + fhirParamName);</span>
			}
<span class="fc" id="L197">		}</span>
<span class="fc" id="L198">	}</span>
	
	/**
	 * Finalize some the parameters and then check for a valid query
	 * @throws HL7Exception Should an error occur during parsing of HL7 content
	 */
	public void update() throws HL7Exception {
<span class="fc bfc" id="L205" title="All 2 branches covered.">		if (!getName().isEmpty()) {</span>
<span class="fc" id="L206">			getName().getNameTypeCode().setValue(&quot;L&quot;);</span>
		}
<span class="fc bfc" id="L208" title="All 2 branches covered.">		if (!getMaiden().isEmpty()) {</span>
<span class="fc" id="L209">			getMaiden().getNameTypeCode().setValue(&quot;M&quot;);</span>
		}
<span class="fc bfc" id="L211" title="All 2 branches covered.">		if (!getAddress().isEmpty()) {</span>
<span class="fc" id="L212">			getAddress().getAddressType().setValue(&quot;L&quot;);</span>
		}
<span class="fc" id="L214">		RCP rcp = (RCP) getQpd().getMessage().get(&quot;RCP&quot;);</span>
<span class="fc" id="L215">		rcp.getQuantityLimitedRequest().getQuantity().setValue(Integer.toString(getCount()));</span>
<span class="fc" id="L216">		rcp.getQuantityLimitedRequest().getUnits().getIdentifier().setValue(&quot;RD&quot;);</span>
<span class="fc" id="L217">		rcp.getQuantityLimitedRequest().getUnits().getText().setValue(&quot;records&quot;);</span>
<span class="fc" id="L218">		rcp.getQuantityLimitedRequest().getUnits().getNameOfCodingSystem().setValue(&quot;HL70126&quot;);</span>
		
<span class="pc bpc" id="L220" title="1 of 2 branches missed.">		if (!isHasId() &amp;&amp; </span>
<span class="nc bnc" id="L221" title="All 2 branches missed.">			(getName().isEmpty() || </span>
<span class="nc bnc" id="L222" title="All 2 branches missed.">			 getBirthDate().isEmpty()) ) {</span>
<span class="nc" id="L223">			throw new IllegalArgumentException(&quot;A query must contain either a &quot;</span>
					+ &quot;patient.identifier or the patient name and birthDate&quot;);
		}
<span class="fc" id="L226">	}</span>

	private void setCount(String param) {
<span class="nc" id="L229">		NumberParam number = new NumberParam();</span>
<span class="nc" id="L230">		number.setValueAsQueryToken(QBPUtils.R4, COUNT, null, param);</span>
<span class="nc" id="L231">		setCount(number.getValue().intValue());</span>
<span class="nc bnc" id="L232" title="All 2 branches missed.">		if (getCount() &gt; 10) {</span>
<span class="nc" id="L233">			throw new IllegalArgumentException(&quot;_count must be &lt;= 10&quot;);</span>
<span class="nc bnc" id="L234" title="All 2 branches missed.">		} else if (getCount() &lt;= 0) {</span>
<span class="nc" id="L235">			throw new IllegalArgumentException(&quot;_count must be &gt; 0&quot;);</span>
		}
<span class="nc" id="L237">	}</span>
	private void setCount(int count) {
<span class="nc" id="L239">		this.count = count;</span>
<span class="nc" id="L240">	}</span>

	private void setMothersMaidenGivenName(String param) throws HL7Exception {
<span class="pc bpc" id="L243" title="1 of 2 branches missed.">		if (getMaiden().getGivenName().isEmpty()) {</span>
<span class="fc" id="L244">			getMaiden().getGivenName().setValue(param);</span>
<span class="nc bnc" id="L245" title="All 2 branches missed.">		} else if (getMaiden().getSecondAndFurtherGivenNamesOrInitialsThereof().isEmpty()) {</span>
<span class="nc" id="L246">			getMaiden().getSecondAndFurtherGivenNamesOrInitialsThereof().setValue(param);</span>
		} else {
<span class="nc" id="L248">			throw new IllegalArgumentException(&quot;Cannot repeat query parameter more than one: &quot; + param + &quot;-given&quot;);</span>
		}
<span class="fc" id="L250">	}</span>

	private void setMothersMaidenName(String param) throws HL7Exception {
<span class="pc bpc" id="L253" title="1 of 2 branches missed.">		if (getMaiden().getFamilyName().getSurname().isEmpty()) {</span>
<span class="fc" id="L254">			getMaiden().getFamilyName().getSurname().setValue(param);</span>
<span class="fc" id="L255">			getMaiden().getNameTypeCode().setValue(&quot;M&quot;);</span>
		} else {
<span class="nc" id="L257">			throw new IllegalArgumentException(IzQuery.CANNOT_REPEAT + param);</span>
		}
<span class="fc" id="L259">	}</span>

	private void setMothersMaidenNameSuffix(String param) throws HL7Exception {
<span class="nc bnc" id="L262" title="All 2 branches missed.">		if (!getMaiden().getSuffixEgJRorIII().isEmpty()) {</span>
<span class="nc" id="L263">			throw new IllegalArgumentException(IzQuery.CANNOT_REPEAT + param + &quot;-suffix&quot;);</span>
		}
<span class="nc" id="L265">		getMaiden().getSuffixEgJRorIII().setValue(param);</span>
<span class="nc" id="L266">	}</span>

	private void setMultipleBirthIndicator(String param) throws HL7Exception{
		TokenParam token;
<span class="nc" id="L270">		token = new TokenParam();</span>
<span class="nc" id="L271">		token.setValueAsQueryToken(QBPUtils.R4, PATIENT_MULTIPLE_BIRTH_INDICATOR, null, param);</span>
<span class="nc" id="L272">		String mbi = token.getValueNotNull();</span>
<span class="nc" id="L273">		ID mbid = QBPUtils.getField(qpd, 10, ID.class);</span>
<span class="nc bnc" id="L274" title="All 2 branches missed.">		if (!mbid.isEmpty()) {</span>
<span class="nc" id="L275">			throw new IllegalArgumentException(IzQuery.CANNOT_REPEAT + param);</span>
		}
<span class="nc bnc" id="L277" title="All 2 branches missed.">		if (mbi.length() != 0) {</span>
<span class="nc bnc" id="L278" title="All 3 branches missed.">			switch (mbi.toLowerCase().charAt(0)) {</span>
			case 'y', 't':
<span class="nc" id="L280">				mbid.setValue(&quot;Y&quot;); break;</span>
			case 'n', 'f':
<span class="nc" id="L282">				mbid.setValue(&quot;N&quot;); break;</span>
			default:
				break;
			}
		}
<span class="nc" id="L287">	}</span>

	private void setMultipleBirthOrder(String param) throws HL7Exception{
<span class="nc" id="L290">		NumberParam number = new NumberParam();</span>
<span class="nc" id="L291">		number.setValueAsQueryToken(QBPUtils.R4, PATIENT_MULTIPLE_BIRTH_ORDER, null, param);</span>
		
<span class="nc" id="L293">		NM nm = QBPUtils.getField(qpd, 11, NM.class);</span>
<span class="nc bnc" id="L294" title="All 2 branches missed.">		if (!nm.isEmpty()) {</span>
<span class="nc" id="L295">			throw new IllegalArgumentException(IzQuery.CANNOT_REPEAT + param);</span>
		}
<span class="nc" id="L297">		nm.setValue(number.getValue().toPlainString());</span>
<span class="nc" id="L298">	}</span>

	private void setPatientAddress(String param) throws HL7Exception{
<span class="pc bpc" id="L301" title="1 of 2 branches missed.">		if (getAddress().getStreetAddress().isEmpty()) {</span>
<span class="fc" id="L302">			getAddress().getStreetAddress().getStreetOrMailingAddress().setValue(param);</span>
<span class="nc bnc" id="L303" title="All 2 branches missed.">		} else if (getAddress().getOtherDesignation().isEmpty()) {</span>
<span class="nc" id="L304">			getAddress().getOtherDesignation().setValue(param);</span>
		} else {
<span class="nc" id="L306">			throw new IllegalArgumentException(&quot;Cannot repeat query parameter more than once: &quot; + param);</span>
		}
<span class="fc" id="L308">	}</span>

	private void setPatientAddressCountry(String param) throws HL7Exception{
<span class="nc bnc" id="L311" title="All 2 branches missed.">		if (!getAddress().getCountry().isEmpty()) {</span>
<span class="nc" id="L312">			throw new IllegalArgumentException(IzQuery.CANNOT_REPEAT + param);</span>
		}
<span class="nc" id="L314">		getAddress().getCountry().setValue(param);</span>
<span class="nc" id="L315">	}</span>

	private void setPatientAddressPostal(String param) throws HL7Exception{
<span class="nc bnc" id="L318" title="All 2 branches missed.">		if (!getAddress().getZipOrPostalCode().isEmpty()) {</span>
<span class="nc" id="L319">			throw new IllegalArgumentException(IzQuery.CANNOT_REPEAT + param);</span>
		}
<span class="nc" id="L321">		getAddress().getZipOrPostalCode().setValue(param);</span>
<span class="nc" id="L322">	}</span>

	private void setPatientAddressState(String param) throws HL7Exception{
<span class="pc bpc" id="L325" title="1 of 2 branches missed.">		if (!getAddress().getStateOrProvince().isEmpty()) {</span>
<span class="nc" id="L326">			throw new IllegalArgumentException(IzQuery.CANNOT_REPEAT + param);</span>
		}
<span class="fc" id="L328">		getAddress().getStateOrProvince().setValue(param);</span>
<span class="fc" id="L329">	}</span>

	private void setPatientBirthDate(String fhirParamName, String param) throws HL7Exception{
<span class="pc bpc" id="L332" title="1 of 2 branches missed.">		if (!getBirthDate().getTime().isEmpty()) {</span>
<span class="nc" id="L333">			throw new IllegalArgumentException(IzQuery.CANNOT_REPEAT + param);</span>
		}
<span class="fc" id="L335">		DateParam dateParam = new DateParam();</span>
<span class="fc" id="L336">		dateParam.setValueAsQueryToken(QBPUtils.R4, fhirParamName, null, param);</span>
<span class="fc" id="L337">		getBirthDate().getTime().setValue(dateParam.getValueAsString().replace(&quot;-&quot;, &quot;&quot;));</span>
<span class="fc" id="L338">	}</span>

	private void setPatientFamilyName(String param) throws HL7Exception{
<span class="pc bpc" id="L341" title="1 of 2 branches missed.">		if (!getName().getFamilyName().isEmpty()) {</span>
<span class="nc" id="L342">			throw new IllegalArgumentException(IzQuery.CANNOT_REPEAT + param);</span>
		}
<span class="fc" id="L344">		getName().getFamilyName().getSurname().setValue(param);</span>
<span class="fc" id="L345">	}</span>

	private void setPatientGender(String fhirParamName, String param) throws HL7Exception{
		TokenParam token;
<span class="pc bpc" id="L349" title="1 of 2 branches missed.">		if (!getGender().isEmpty()) {</span>
<span class="nc" id="L350">			throw new IllegalArgumentException(IzQuery.CANNOT_REPEAT + param);</span>
		}
<span class="fc" id="L352">		token = new TokenParam();</span>
<span class="fc" id="L353">		token.setValueAsQueryToken(QBPUtils.R4, fhirParamName, null, param);</span>
<span class="pc bpc" id="L354" title="1 of 2 branches missed.">		if (token.getValueNotNull().length() == 0) {</span>
<span class="nc" id="L355">			token.setValue(&quot;U&quot;);	// Per CDC Guide</span>
		}
		// HL7 codes are same as first character of FHIR codes.
<span class="fc" id="L358">		getGender().setValue(token.getValue().substring(0, 1).toUpperCase());</span>
<span class="fc" id="L359">	}</span>

	private void setPatientGivenName(String param) throws HL7Exception{
<span class="fc bfc" id="L362" title="All 2 branches covered.">		if (getName().getGivenName().isEmpty()) {</span>
<span class="fc" id="L363">			getName().getGivenName().setValue(param);</span>
<span class="pc bpc" id="L364" title="1 of 2 branches missed.">		} else if (getName().getSecondAndFurtherGivenNamesOrInitialsThereof().isEmpty()) {</span>
<span class="fc" id="L365">			getName().getSecondAndFurtherGivenNamesOrInitialsThereof().setValue(param);</span>
		} else {
<span class="nc" id="L367">			throw new IllegalArgumentException(&quot;Cannot repeat query parameter more than once: &quot; + param);</span>
		}
<span class="fc" id="L369">	}</span>

	private void setPatientList(String fhirParamName, String param) throws HL7Exception{
		TokenParam token;
<span class="fc" id="L373">		token = new TokenParam();</span>
<span class="fc" id="L374">		token.setValueAsQueryToken(QBPUtils.R4, fhirParamName, null, param);</span>

<span class="fc" id="L376">		hasId = true;</span>
		// get QPD-3
<span class="fc" id="L378">		CX cx = QBPUtils.addRepetition(qpd, 3, CX.class);</span>
<span class="fc" id="L379">		cx.getIDNumber().setValue(token.getValue());</span>
<span class="fc" id="L380">		cx.getAssigningAuthority().getNamespaceID().setValue(token.getSystem());</span>
<span class="fc" id="L381">		cx.getIdentifierTypeCode().setValue(&quot;MR&quot;);  // Per CDC Guide</span>
<span class="fc" id="L382">	}</span>

	private void setPatientNameSuffix(String param) throws HL7Exception{
<span class="nc bnc" id="L385" title="All 2 branches missed.">		if (getName().getSuffixEgJRorIII().isEmpty()) {</span>
<span class="nc" id="L386">			getName().getSuffixEgJRorIII().setValue(param);</span>
		} else {
<span class="nc" id="L388">			throw new IllegalArgumentException(IzQuery.CANNOT_REPEAT + param);</span>
		}
<span class="nc" id="L390">	}</span>

	private void setPatientPhone(String param) throws HL7Exception{
		TokenParam token;
<span class="nc" id="L394">		token = new TokenParam();</span>
<span class="nc" id="L395">		param = param.split(&quot;,&quot;)[0]; // Take the first value provided</span>
<span class="nc" id="L396">		token.setValueAsQueryToken(QBPUtils.R4, PATIENT_HOMEPHONE, null, param);</span>
<span class="nc bnc" id="L397" title="All 2 branches missed.">		if (!getTelephone().isEmpty()) {</span>
<span class="nc" id="L398">			throw new IllegalArgumentException(IzQuery.CANNOT_REPEAT + param);</span>
		}
<span class="nc" id="L400">		getTelephone().setValue(token.getValue());</span>
<span class="nc" id="L401">	}</span>

	private void setPatientSuffixCity(String param) throws HL7Exception{
<span class="pc bpc" id="L404" title="1 of 2 branches missed.">		if (!getAddress().getCity().isEmpty()) {</span>
<span class="nc" id="L405">			throw new IllegalArgumentException(IzQuery.CANNOT_REPEAT + param);</span>
		}
<span class="fc" id="L407">		getAddress().getCity().setValue(param);</span>
<span class="fc" id="L408">	}</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.13.202504020838</span></div></body></html>