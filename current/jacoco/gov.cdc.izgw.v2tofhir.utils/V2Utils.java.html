<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>V2Utils.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">HL7 Version 2 to FHIR Conversion</a> &gt; <a href="index.source.html" class="el_package">gov.cdc.izgw.v2tofhir.utils</a> &gt; <span class="el_source">V2Utils.java</span></div><h1>V2Utils.java</h1><pre class="source lang-java linenums">package gov.cdc.izgw.v2tofhir.utils;

import java.util.function.BiConsumer;
import java.util.function.Consumer;

import ca.uhn.hl7v2.HL7Exception;
import ca.uhn.hl7v2.model.Segment;
import ca.uhn.hl7v2.model.Type;
import gov.cdc.izgw.v2tofhir.converter.DatatypeConverter;

/**
 * Utilities for manipulating V2 messages for FHIR Conversion
 * 
 * @author Audacious Inquiry
 */
public class V2Utils {
	private V2Utils() {
		// Static class
	}
	/** 
	 * Convenience method to add a single field to a resource
	 * 
	 * 	Use:
	 * &lt;pre&gt;
	 * 		addField(pid, 4, patient, Identifier.class, patient::addIdentifier);
	 * &lt;/pre&gt;
	 *  Instead of:
	 *  &lt;pre&gt;
	 *  	Type t = getField(pid, 4);
	 *  	Identifier ident = DatatypeConverter.toIdentifier(t);
	 *  	if (ident != null &amp;amp;&amp;amp; !ident.isEmpty()) {
	 *  		patient.addIdentifier(ident);
	 *  	}
	 *  &lt;/pre&gt;
	 * @param &lt;F&gt;	The FHIR type to add
	 * @param pid	The segment from which the value comes
	 * @param fieldNo	The field from which the value comes
	 * @param clazz	The datatype to create from the field
	 * @param adder	The adder function
	 */
	public static &lt;F extends org.hl7.fhir.r4.model.Type&gt; 
		void addField(Segment pid, int fieldNo, Class&lt;F&gt; clazz, Consumer&lt;F&gt; adder
	) {
<span class="nc" id="L44">		FhirUtils.ifNotEmpty(DatatypeConverter.convert(clazz, getField(pid, fieldNo), null), adder);</span>
<span class="nc" id="L45">	}</span>

	/** 
	 * Convenience method to add a single field to a resource
	 * 
	 * 	Use:
	 * &lt;pre&gt;
	 * 		addField(pid, 7, patient, DateTimeType.class, this::addBirthDateTime);
	 * &lt;/pre&gt;
	 *  Instead of:
	 *  &lt;pre&gt;
	 *  	Type t = getField(pid, 7);
	 *  	DateTimeType dt = DatatypeConverter.toDateTimeType(t);
	 *  	if (dt != null &amp;amp;&amp;amp; !dt.isEmpty()) {
	 *  		this.addBirthDateTime(patient, dt);
	 *  	}
	 *  &lt;/pre&gt;
	 * @param &lt;F&gt;	The FHIR type to add
	 * @param &lt;R&gt;	The Resource to add it to
	 * @param pid	The segment from which the value comes
	 * @param fieldNo	The field from which the value comes
	 * @param resource	The resource to add to
	 * @param clazz	The datatype to create from the field
	 * @param adder	The adder function
	 */
	public static &lt;R extends org.hl7.fhir.r4.model.Resource, F extends org.hl7.fhir.r4.model.Type&gt; 
	void addField(Segment pid, int fieldNo, Class&lt;F&gt; clazz, R resource, BiConsumer&lt;R, F&gt; adder) {
<span class="nc" id="L72">		FhirUtils.ifNotEmpty(DatatypeConverter.convert(clazz, getField(pid, fieldNo), null),  t -&gt; adder.accept(resource, t));</span>
<span class="nc" id="L73">	}</span>

	/** 
	 * Convenience method to add a multiple fields to a resource
	 * 
	 * Use:
	 * &lt;pre&gt;
	 * 		addFields(pid, 11, patient, Address.class, patient::addAddress);
	 * &lt;/pre&gt;
	 * 
	 * Instead of:
	 *  &lt;pre&gt;
	 *  	Type[] types = getFields(pid, 11);
	 *  	for (Type t: types) {
	 *  		Address addr = DatatypeConverter.toAddress(t);
	 *  		if (addr != null &amp;amp;&amp;amp; !addr.isEmpty()) {
	 *  			patient.addAddress(ident);
	 *  		}
	 *  	}
	 *  &lt;/pre&gt;
	 * @param &lt;F&gt;	The FHIR type to add
	 * @param pid	The segment from which the value comes
	 * @param fieldNo	The field from which the value comes
	 * @param clazz	The datatype to create from the field
	 * @param adder	The adder function
	 */
	public static &lt;F extends org.hl7.fhir.r4.model.Type&gt; void addFields(Segment pid, int fieldNo, Class&lt;F&gt; clazz, Consumer&lt;F&gt; adder) {
<span class="nc bnc" id="L100" title="All 2 branches missed.">		for (Type type: getFields(pid, fieldNo)) {</span>
<span class="nc" id="L101">			FhirUtils.ifNotEmpty(DatatypeConverter.convert(clazz, type, null), adder);</span>
		}
<span class="nc" id="L103">	}</span>

	/** 
	 * Convenience method to add a multiple fields to a resource
	 * 
	 * Use:
	 * &lt;pre&gt;
	 * 		addFields(pid, 10, patient, CodeableConcept.class, this::addRace);
	 * &lt;/pre&gt;
	 * 
	 * Instead of:
	 * &lt;pre&gt;
	 *  	Type[] types = getField(pid, 10);
	 *  	for (Type t: types) {
	 *  		CodeableConcept cc = DatatypeConverter.toCodeableConcept(t);
	 *  		if (cc != null &amp;amp;&amp;amp; !cc.isEmpty()) {
	 *  			this.addRace(patient, cc);
	 *  		}
	 *  	}
	 * &lt;/pre&gt;
	 * 
	 * @param &lt;R&gt;	The FHIR Resource to add
	 * @param &lt;F&gt;	The FHIR type to add
	 * @param pid	The segment from which the value comes
	 * @param fieldNo	The field from which the value comes
	 * @param patient	The resource to add to
	 * @param clazz	The datatype to create from the field
	 * @param adder	The adder function
	 */
	public static &lt;R extends org.hl7.fhir.r4.model.Resource, F extends org.hl7.fhir.r4.model.Type&gt; 
		void addFields(Segment pid, int fieldNo, Class&lt;F&gt; clazz, R patient, BiConsumer&lt;R, F&gt; adder
	) {
<span class="nc bnc" id="L135" title="All 2 branches missed.">		for (Type type: getFields(pid, fieldNo)) {</span>
<span class="nc" id="L136">			FhirUtils.ifNotEmpty(DatatypeConverter.convert(clazz, type, null), t -&gt; adder.accept(patient, t));</span>
		}
<span class="nc" id="L138">	}</span>

	/**
	 * Get the first occurrence of the specified field from an HL7 V2 segment.
	 * @param segment	The segment to get the field for.
	 * 
	 * This is a convenience method to get a field that does not throw exceptions
	 * the way that segment.getField() does.
	 * 
	 * @param field	The field number
	 * @return	The specified field, or null of the field does not exist or is empty.
	 */
	public static Type getField(Segment segment, int field) {
<span class="pc bpc" id="L151" title="1 of 2 branches missed.">		if (segment == null) {</span>
<span class="nc" id="L152">			return null;</span>
		}
		try {
<span class="fc" id="L155">			Type[] types = segment.getField(field); </span>
<span class="fc bfc" id="L156" title="All 2 branches covered.">			if (types.length == 0) {</span>
<span class="fc" id="L157">				return null;</span>
			}
<span class="pc bpc" id="L159" title="1 of 2 branches missed.">			return types[0].isEmpty() ? null : types[0];</span>
<span class="nc" id="L160">		} catch (HL7Exception e) {</span>
<span class="nc" id="L161">			return null;</span>
		}
	}

	/**
	 * Get all occurrences of the specified field from an HL7 V2 segment.
	 * @param segment	The segment to get the field for.
	 * 
	 * This is a convenience method to get a field that does not throw exceptions
	 * the way that segment.getField() does.
	 * 
	 * @param field	The field number
	 * @return	An array containing all occurrences of the specified field. 
	 */
	public static Type[] getFields(Segment segment, int field) {
<span class="pc bpc" id="L176" title="1 of 2 branches missed.">		if (segment == null) {</span>
<span class="nc" id="L177">			return new Type[0];</span>
		}
		try {
<span class="fc" id="L180">			return segment.getField(field);</span>
<span class="nc" id="L181">		} catch (HL7Exception e) {</span>
<span class="nc" id="L182">			return new Type[0];</span>
		}
	}

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.13.202504020838</span></div></body></html>