<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>FhirIdCodec.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">HL7 Version 2 to FHIR Conversion</a> &gt; <a href="index.source.html" class="el_package">gov.cdc.izgw.v2tofhir.utils</a> &gt; <span class="el_source">FhirIdCodec.java</span></div><h1>FhirIdCodec.java</h1><pre class="source lang-java linenums">package gov.cdc.izgw.v2tofhir.utils;

import java.io.PrintStream;
import java.math.BigInteger;
import java.nio.charset.StandardCharsets;
import java.util.Base64;
import java.util.IllegalFormatCodePointException;

import org.apache.commons.lang3.StringUtils;

/**
 * FhirIdCodec enables encoding and decoding of ASCII printable strings into the
 * allowable characters from the FHIR IdType set. The encoding is essentially
 * the same as RFC-4648, except that underscore (_) is replaced with a period (.).
 * 
 * This class uses the Java Base64 encoder and decoder to effect encoding
 * and decoding, simply replacing the _ with . after encoding, and reversing
 * that prior to decoding.
 * 
 * This encoder can handle up to 58 characters before it exceeds the length
 * of a FHIR IdType.
 * 
 * This allows arbitrary data of a limited length to be encoded into a FHIR 
 * IdType object.
 *
 */
public class FhirIdCodec {
	private FhirIdCodec() { }
	
<span class="nc" id="L30">	private static Base64.Encoder ENCODER = Base64.getUrlEncoder();</span>
<span class="nc" id="L31">	private static Base64.Decoder DECODER = Base64.getUrlDecoder();</span>

	/**
	 * Encode a string into the FHIR id character set.
	 * 
	 * @param value	The string to encode
	 * @return	The encoded value
	 */
	public static String encode(String value) {
<span class="nc" id="L40">		byte[] data = value.getBytes(StandardCharsets.UTF_8);</span>
<span class="nc" id="L41">		return StringUtils.replaceChars(ENCODER.encodeToString(data), &quot;_=&quot;, &quot;.&quot;);</span>
	}
	/**
	 * Decode a string into the FHIR id character set.
	 * 
	 * @param value	The string to decode
	 * @return	The decoded value
	 * @throws IllegalFormatCodePointException if the value could properly not be decoded as a Unicode String
	 */
	public static String decode(String value) {
<span class="nc" id="L51">		value = value.replace(&quot;.&quot;, &quot;_&quot;);</span>
<span class="nc" id="L52">		byte[] data = DECODER.decode(value);</span>
<span class="nc" id="L53">		String result = new String(data, StandardCharsets.UTF_8);</span>
<span class="nc bnc" id="L54" title="All 2 branches missed.">		if (result.contains(&quot;\uFFFD&quot;)) {</span>
<span class="nc" id="L55">			throw new IllegalFormatCodePointException(0xFFFD);</span>
		}
<span class="nc" id="L57">		return result;</span>
	}
	

	/**
	 * Encode an ASCII string into the FHIR id character set.
	 * @param value	The value to encode.
	 * @return	The encoded value.
	 */
	public static String encodeAscii(String value) {
<span class="nc bnc" id="L67" title="All 2 branches missed.">		if (!StringUtils.isAsciiPrintable(value)) {</span>
<span class="nc" id="L68">			throw new IllegalArgumentException(&quot;Value contains non ASCII-printable characters&quot;);</span>
		} 
		
<span class="nc" id="L71">		byte[] data = value.getBytes(StandardCharsets.US_ASCII);</span>
<span class="nc" id="L72">		data = packAsciiBytes(data);</span>
<span class="nc" id="L73">		return StringUtils.replaceChars(ENCODER.encodeToString(data), &quot;_=&quot;, &quot;.&quot;);</span>
	}
	
	/**
	 * Decode an ASCII string from the FHIR id character set.
	 * @param value	The value to decode.
	 * @return A string containing the decoded value.
	 * @throws IllegalFormatCodePointException if the decoded characters are non-ASCII
	 */
	public static String decodeAscii(String value) {
<span class="nc" id="L83">		value = value.replace(&quot;.&quot;, &quot;_&quot;);</span>
<span class="nc" id="L84">		byte[] data = DECODER.decode(value);</span>
<span class="nc" id="L85">		BigInteger result = new BigInteger(data);</span>
<span class="nc" id="L86">		StringBuilder b = new StringBuilder();</span>
<span class="nc" id="L87">		BigInteger mult = BigInteger.valueOf(96);</span>
<span class="nc bnc" id="L88" title="All 2 branches missed.">		while (!result.equals(BigInteger.ZERO)) {</span>
<span class="nc" id="L89">			BigInteger[] div = result.divideAndRemainder(mult);</span>
<span class="nc" id="L90">			byte v = div[1].byteValue();</span>
<span class="nc" id="L91">			result = div[0];</span>
<span class="nc bnc" id="L92" title="All 4 branches missed.">			if (v &lt; 0 || v &gt;= 96) {</span>
<span class="nc" id="L93">				throw new IllegalFormatCodePointException(v + 32);</span>
			}
<span class="nc" id="L95">			v += 32;</span>
<span class="nc" id="L96">			b.append((char)v);</span>
<span class="nc" id="L97">		}</span>
		// Reverse the data
<span class="nc bnc" id="L99" title="All 2 branches missed.">		for (int i = 0, j = b.length() - 1; i &lt; j; i++, j--) {</span>
<span class="nc" id="L100">			char left = b.charAt(i);</span>
<span class="nc" id="L101">			b.setCharAt(i, b.charAt(j));</span>
<span class="nc" id="L102">			b.setCharAt(j, left);</span>
		}
<span class="nc" id="L104">		return b.toString();</span>
	}
	
	/**
	 * Print binary data in HEX and ASCII in a human readable form
	 * @param out	The output stream to write to
	 * @param data	The data to write
	 */
	public static void dumpHex(PrintStream out, byte[] data) {
<span class="nc" id="L113">		int counter = 0;</span>
<span class="nc bnc" id="L114" title="All 2 branches missed.">		for (byte b: data) {</span>
<span class="nc" id="L115">			out.printf(&quot;%02X&quot;, b);</span>
<span class="nc bnc" id="L116" title="All 2 branches missed.">			if (++counter % 4 == 0) out.print(&quot; &quot;);</span>
		}
<span class="nc" id="L118">		counter = 0;</span>
<span class="nc" id="L119">		out.print(&quot;  &quot;);</span>
<span class="nc bnc" id="L120" title="All 2 branches missed.">		for (byte b: data) {</span>
<span class="nc bnc" id="L121" title="All 2 branches missed.">			char c = ((b &amp; 0xff) &lt; 32) ? '.' : (char)(b &amp; 0xff);</span>
<span class="nc" id="L122">			out.printf(&quot;%c&quot;, c);</span>
<span class="nc bnc" id="L123" title="All 2 branches missed.">			if (++counter % 8 == 0) out.print(&quot; &quot;);</span>
		}
<span class="nc" id="L125">		out.println();</span>
<span class="nc" id="L126">	}</span>
	
	/**
	 * Pack ASCII printable characters into data as tightly as possible.
	 * @param data	The ASCII characters to pack.
	 * @return	The packed character array.
	 */
	private static byte[] packAsciiBytes(byte[] data) {
<span class="nc" id="L134">		BigInteger result = BigInteger.ZERO;</span>
<span class="nc" id="L135">		BigInteger mult = BigInteger.valueOf(96);</span>
<span class="nc bnc" id="L136" title="All 2 branches missed.">		for (byte b: data) {</span>
<span class="nc" id="L137">			result = result.multiply(mult);	// Multiplier = 96</span>
<span class="nc" id="L138">			int v = (b &amp; 0x7F) - 32;		// Now in range of 0-95</span>
<span class="nc" id="L139">			result = result.add(BigInteger.valueOf(v));</span>
		}
<span class="nc" id="L141">		return result.toByteArray();</span>
	}
	
	/**
	 * Test route
	 * @param args	Strings to convert	
	 */
	public static void main(String ... args) {
		// Default values to use for testing.
<span class="nc" id="L150">		String[] values = {</span>
			&quot;MYEHR|234814&quot;,
			&quot;MYEHR|234814Z&quot;,
			&quot;MYEHR|234814ZZ&quot;,
			&quot;MYEHR%7C234814&quot;,
			&quot;MYEHR%7C234814Z&quot;,
			&quot;MYEHR%7C234814ZZ&quot;,
			&quot;~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~&quot;,
			&quot;~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~&quot;,
			&quot;~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~&quot;,
			&quot;~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~&quot;,
			&quot;~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~&quot;,
			&quot;!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!&quot;,
			&quot;!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!&quot;,
			&quot;!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!&quot;,
			&quot;!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!&quot;,
			&quot;!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!&quot;,
			&quot;!                                                     !&quot;,
			&quot;!                                                      !&quot;,
			&quot;!                                                       !&quot;,
			&quot;!                                                        !&quot;,
			&quot;!                                                         !&quot;,
		};
<span class="nc bnc" id="L173" title="All 2 branches missed.">		if (args.length != 0) {</span>
<span class="nc" id="L174">			values = args;</span>
		}
<span class="nc bnc" id="L176" title="All 2 branches missed.">		for (String value: values) {</span>
<span class="nc" id="L177">			String encode = encode(value);</span>
<span class="nc" id="L178">			String decode = decode(encode);</span>
<span class="nc" id="L179">			System.out.printf(&quot;'%s'(%d) -&gt; '%s'(%d) -&gt; '%s' : %s%n&quot;, value, value.length(), encode, encode.length(), decode, value.equals(decode));</span>
		}
<span class="nc" id="L181">	}</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.13.202504020838</span></div></body></html>