<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>FhirConverter.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">HL7 Version 2 to FHIR Conversion</a> &gt; <a href="index.source.html" class="el_package">gov.cdc.izgw.v2tofhir.utils</a> &gt; <span class="el_source">FhirConverter.java</span></div><h1>FhirConverter.java</h1><pre class="source lang-java linenums">package gov.cdc.izgw.v2tofhir.utils;

import java.io.BufferedInputStream;
import java.io.IOException;
import java.io.OutputStreamWriter;
import java.util.List;
import org.apache.commons.io.IOUtils;
import org.apache.commons.lang3.StringUtils;
import org.hl7.fhir.r4.model.Binary;
import org.hl7.fhir.r4.model.Resource;
import org.springframework.http.HttpHeaders;
import org.springframework.http.HttpInputMessage;
import org.springframework.http.HttpOutputMessage;
import org.springframework.http.MediaType;
import org.springframework.http.converter.HttpMessageConverter;
import org.springframework.http.converter.HttpMessageNotReadableException;
import org.springframework.http.converter.HttpMessageNotWritableException;

import ca.uhn.fhir.parser.IParser;

/**
 * This is a converter to and from FHIR for SpringBoot applications that are
 * not using the HAPI on FHIR native web server. 
 */
<span class="nc" id="L25">public class FhirConverter implements HttpMessageConverter&lt;Resource&gt; {</span>
	@Override
	public boolean canRead(Class&lt;?&gt; clazz, MediaType mediaType) {
<span class="nc bnc" id="L28" title="All 2 branches missed.">		mediaType = mediaType == null ? null : new MediaType(StringUtils.lowerCase(mediaType.getType()), StringUtils.lowerCase(mediaType.getSubtype()));</span>
<span class="nc bnc" id="L29" title="All 6 branches missed.">		return Resource.class.isAssignableFrom(clazz) &amp;&amp; (mediaType == null || ContentUtils.FHIR_MEDIA_TYPES.contains(mediaType));</span>
	}

	@Override
	public boolean canWrite(Class&lt;?&gt; clazz, MediaType mediaType) {
<span class="nc bnc" id="L34" title="All 2 branches missed.">		String subtype = mediaType != null ? StringUtils.lowerCase(mediaType.getSubtype()) : &quot;&quot;;</span>
<span class="nc bnc" id="L35" title="All 8 branches missed.">		if (Binary.class.isAssignableFrom(clazz) &amp;&amp; mediaType != null &amp;&amp; (subtype.contains(&quot;cda&quot;) || subtype.contains(&quot;hl7v2&quot;))) {</span>
<span class="nc" id="L36">			return true;</span>
		}
<span class="nc" id="L38">		return canRead(clazz, mediaType);</span>
	}

	@Override
	public List&lt;MediaType&gt; getSupportedMediaTypes() {
<span class="nc" id="L43">		return ContentUtils.HL7_MEDIA_TYPES;</span>
	}

	@Override
	public Resource read(Class&lt;? extends Resource&gt; clazz, HttpInputMessage inputMessage)
			throws IOException, HttpMessageNotReadableException {
		
<span class="nc" id="L50">		IParser parser = null;</span>
<span class="nc" id="L51">		String contentType = inputMessage.getHeaders().getFirst(HttpHeaders.CONTENT_TYPE);</span>
<span class="nc" id="L52">		MediaType mediaType = null;</span>
		
<span class="nc" id="L54">		BufferedInputStream bis = IOUtils.buffer(inputMessage.getBody());</span>
<span class="nc bnc" id="L55" title="All 2 branches missed.">		if (StringUtils.isBlank(contentType)) {</span>
<span class="nc" id="L56">			mediaType = ContentUtils.guessMediaType(bis);</span>
		} else {
<span class="nc" id="L58">			mediaType = new MediaType(contentType);</span>
			// Simplify it.
<span class="nc" id="L60">			mediaType = new MediaType(mediaType.getType(), mediaType.getType());</span>
		}
<span class="nc" id="L62">		parser = ContentUtils.selectParser(mediaType);</span>
<span class="nc" id="L63">		return parser.parseResource(clazz, bis);</span>
	}

	@Override
	public void write(Resource resource, MediaType contentType, HttpOutputMessage outputMessage)
			throws IOException, HttpMessageNotWritableException {
<span class="nc bnc" id="L69" title="All 4 branches missed.">		if (resource instanceof Binary b &amp;&amp; ContentUtils.FHIR_MEDIA_TYPES.stream().noneMatch(t -&gt; t.includes(contentType))) {</span>
<span class="nc" id="L70">			writeBinary(b, outputMessage);</span>
<span class="nc" id="L71">			return;</span>
		}
<span class="nc" id="L73">		IParser parser = ContentUtils.selectParser(contentType);</span>
<span class="nc" id="L74">		OutputStreamWriter w = null;</span>
		try {  // NOSONAR: It's up to the caller to determine whether the body gets closed when this is done.
<span class="nc" id="L76">			w = new OutputStreamWriter(outputMessage.getBody());</span>
<span class="nc" id="L77">			parser.encodeResourceToWriter(resource, w);</span>
		} finally {
<span class="nc bnc" id="L79" title="All 2 branches missed.">			if (w != null) {</span>
<span class="nc" id="L80">				w.flush();</span>
			}
		}
<span class="nc" id="L83">	}</span>

	private void writeBinary(Binary b, HttpOutputMessage outputMessage) throws IOException {
<span class="nc" id="L86">		OutputStreamWriter w = null;</span>
		try {  // NOSONAR: It's up to the caller to determine whether the body gets closed when this is done.
<span class="nc" id="L88">			w = new OutputStreamWriter(outputMessage.getBody());</span>
<span class="nc bnc" id="L89" title="All 2 branches missed.">			for (byte data: b.getData()) {</span>
<span class="nc" id="L90">				w.write((char)data);</span>
			}
		} finally {
<span class="nc bnc" id="L93" title="All 2 branches missed.">			if (w != null) {</span>
<span class="nc" id="L94">				w.flush();</span>
			}
		}
		
<span class="nc" id="L98">	}</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.13.202504020838</span></div></body></html>