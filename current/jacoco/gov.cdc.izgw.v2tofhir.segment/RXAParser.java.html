<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>RXAParser.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">HL7 Version 2 to FHIR Conversion</a> &gt; <a href="index.source.html" class="el_package">gov.cdc.izgw.v2tofhir.segment</a> &gt; <span class="el_source">RXAParser.java</span></div><h1>RXAParser.java</h1><pre class="source lang-java linenums">package gov.cdc.izgw.v2tofhir.segment;

import java.util.ArrayList;
import java.util.List;

import org.apache.commons.lang3.StringUtils;
import org.hl7.fhir.instance.model.api.IBaseResource;
import org.hl7.fhir.r4.model.Address;
import org.hl7.fhir.r4.model.CodeableConcept;
import org.hl7.fhir.r4.model.Coding;
import org.hl7.fhir.r4.model.DateTimeType;
import org.hl7.fhir.r4.model.DateType;
import org.hl7.fhir.r4.model.DecimalType;
import org.hl7.fhir.r4.model.Identifier;
import org.hl7.fhir.r4.model.Immunization;
import org.hl7.fhir.r4.model.Immunization.ImmunizationPerformerComponent;
import org.hl7.fhir.r4.model.Immunization.ImmunizationStatus;
import org.hl7.fhir.r4.model.ImmunizationRecommendation.ImmunizationRecommendationRecommendationComponent;
import org.hl7.fhir.r4.model.Location;
import org.hl7.fhir.r4.model.Organization;
import org.hl7.fhir.r4.model.Practitioner;
import org.hl7.fhir.r4.model.Reference;
import org.hl7.fhir.r4.model.StringType;

import gov.cdc.izgw.v2tofhir.annotation.ComesFrom;
import gov.cdc.izgw.v2tofhir.annotation.Produces;
import gov.cdc.izgw.v2tofhir.converter.DatatypeConverter;
import gov.cdc.izgw.v2tofhir.converter.MessageParser;
import gov.cdc.izgw.v2tofhir.utils.Codes;
import gov.cdc.izgw.v2tofhir.utils.Mapping;
import gov.cdc.izgw.v2tofhir.utils.ParserUtils;
import gov.cdc.izgw.v2tofhir.utils.Systems;

/**
 * RXAParser parses any RXA segments in a message to an Immunization if the message is a VXU or an 
 * response to an immunization query.
 * 
 * @author Audacious Inquiry
 *
 * @see &lt;a href=&quot;https://hl7.org/fhir/uv/v2mappings/2024Jan/ConceptMap-segment-rxa-to-immunization.html&quot;&gt;V2 to FHIR: RXA to Immunization&lt;/a&gt;
 */
@Produces(segment = &quot;RXA&quot;, resource=Immunization.class, 
	extra = { Practitioner.class, Organization.class }
)
public class RXAParser extends AbstractSegmentParser {
<span class="fc" id="L46">	private static List&lt;FieldHandler&gt; fieldHandlers = new ArrayList&lt;&gt;();</span>
	private IzDetail izDetail;
	private ImmunizationRecommendationRecommendationComponent recommendation;
	
	/**
	 * Create an RXA Parser for the specified MessageParser
	 * @param p	The message parser.
	 */
	public RXAParser(MessageParser p) {
<span class="fc" id="L55">		super(p, &quot;RXA&quot;);</span>
<span class="fc bfc" id="L56" title="All 2 branches covered.">		if (fieldHandlers.isEmpty()) {</span>
<span class="fc" id="L57">			FieldHandler.initFieldHandlers(this, fieldHandlers);</span>
		}
<span class="fc" id="L59">	}</span>

	@Override
	protected List&lt;FieldHandler&gt; getFieldHandlers() {
<span class="fc" id="L63">		return fieldHandlers;</span>
	}

	@Override
	public IBaseResource setup() {
<span class="fc" id="L68">		izDetail = IzDetail.get(getMessageParser());</span>
<span class="fc" id="L69">		izDetail.initializeResources(false, getSegment());</span>
<span class="fc bfc" id="L70" title="All 2 branches covered.">		if (izDetail.hasImmunization()) {</span>
<span class="fc" id="L71">			return izDetail.immunization;</span>
<span class="pc bpc" id="L72" title="1 of 2 branches missed.">		} else if (izDetail.hasRecommendation()) {</span>
<span class="fc" id="L73">			recommendation = izDetail.immunizationRecommendation.addRecommendation();</span>
<span class="fc" id="L74">			return izDetail.immunizationRecommendation;</span>
		}
		// Until we support RXA more generally, we don't know what to do with this segment 
<span class="nc" id="L77">		return null;</span>
	}
	
	/*
	3	RXA-3	Date/Time Start of Administration	DTM	1	1				Immunization.occurrenceDateTime		Immunization.dateTime	1	1				
	*/
	/**
	 * Set the administration date time.
	 * @param administrationDateTime the administration date time	
	 */
	@ComesFrom(path = &quot;Immunization.occurrenceDateTime&quot;, field = 3, comment = &quot;Date/Time Start of Administration&quot;)
	public void setAdministrationDateTime(DateTimeType administrationDateTime) {
<span class="fc bfc" id="L89" title="All 2 branches covered.">		if (izDetail.hasImmunization()) {</span>
<span class="fc" id="L90">			izDetail.immunization.setOccurrence(administrationDateTime);</span>
<span class="pc bpc" id="L91" title="1 of 2 branches missed.">		} else if (izDetail.hasRecommendation()) {</span>
<span class="fc" id="L92">			recommendation.getDateCriterionFirstRep().setValueElement(administrationDateTime);</span>
		}
<span class="fc" id="L94">	}</span>
	/*
	5	RXA-5	Administered Code	CWE	1	1				Immunization.vaccineCode		Immunization.CodeableConcept	1	1	CWE[CodeableConcept]			
	*/
	/**
	 * Set the vaccine code
	 * @param vaccineCode	the vaccine code
	 */
	@ComesFrom(path = &quot;Immunization.vaccineCode&quot;, field = 5, table = &quot;0292&quot;, comment = &quot;Administered Code&quot;)
	public void setVaccineCode(CodeableConcept vaccineCode) {
		// CDC says RXA-5 cannot repeat, but STC example shows a repeat, handle the
		// repeat as additional codes.
<span class="fc bfc" id="L106" title="All 2 branches covered.">		if (izDetail.hasImmunization()) {</span>
<span class="pc bpc" id="L107" title="1 of 2 branches missed.">			if (izDetail.immunization.hasVaccineCode()) {</span>
<span class="nc bnc" id="L108" title="All 2 branches missed.">				for (Coding coding: vaccineCode.getCoding()) {</span>
<span class="nc" id="L109">					izDetail.immunization.getVaccineCode().addCoding(coding);</span>
<span class="nc" id="L110">				}</span>
			} else {
<span class="fc" id="L112">				izDetail.immunization.setVaccineCode(vaccineCode);</span>
			}
<span class="pc bpc" id="L114" title="1 of 2 branches missed.">		} else if (izDetail.hasRecommendation()) {</span>
<span class="pc bpc" id="L115" title="1 of 2 branches missed.">			if (recommendation.hasVaccineCode()) {</span>
<span class="nc bnc" id="L116" title="All 2 branches missed.">				for (Coding coding: vaccineCode.getCoding()) {</span>
<span class="nc" id="L117">					recommendation.getVaccineCodeFirstRep().addCoding(coding);</span>
<span class="nc" id="L118">				}</span>
			} else {
<span class="fc" id="L120">				recommendation.addVaccineCode(vaccineCode);</span>
			}
		}
<span class="fc" id="L123">	}</span>
	/*
	6	RXA-6	Administered Amount	NM	1	1				Immunization.doseQuantity.value		Immunization.decimal	0	1				
	*/
	/**
	 * Set the dose amount
	 * @param doseQuantity the dose amount
	 */
	@ComesFrom(path = &quot;Immunization.doseQuantity.value&quot;, field = 6, comment = &quot;Administered Amount&quot;)
	public void setDoseAmount(DecimalType doseQuantity) {
<span class="fc bfc" id="L133" title="All 2 branches covered.">		if (izDetail.hasImmunization()) {</span>
<span class="fc" id="L134">			izDetail.immunization.getDoseQuantity().setValueElement(doseQuantity);</span>
		}
<span class="fc" id="L136">	}</span>
	/*
	7	RXA-7	Administered Units	CWE	0	1				Immunization.doseQuantity		Immunization.SimpleQuantity	0	1	CWE[Quantity]			
	*/
	/**
	 * Set the dose units
	 * @param doseUnits the dose units
	 */
	@ComesFrom(path = &quot;Immunization.doseQuantity.code&quot;, field = 7, comment = &quot;Administered Units&quot;,
			also = &quot;Immunization.doseQuantity.unit&quot;)
	public void setDoseAmount(CodeableConcept doseUnits) {
<span class="fc bfc" id="L147" title="All 2 branches covered.">		if (izDetail.hasImmunization()) {</span>
<span class="fc" id="L148">			DatatypeConverter.setUnits(izDetail.immunization.getDoseQuantity(), doseUnits);</span>
		}
<span class="fc" id="L150">	}</span>
	
	/*
	10	RXA-10	Administering Provider	XCN	0	-1				Immunization.performer.actor(Immunization.Practitioner)		Reference(Immunization.Practitioner)	0	-1	XCN[Practitioner]			
	*/
	/*
	10	RXA-10	Administering Provider	XCN	0	-1				Immunization.performer.function.coding.code		Immunization.code					&quot;AP&quot;	
	*/
	/*
	10	RXA-10	Administering Provider	XCN	0	-1				Immunization.performer.function.coding.system		Immunization.uri					&quot;http://terminology.hl7.org/CodeSystem/v2-0443&quot;	
	*/
	// CVX 48, 49, MVX MSD
	/**
	 * Set the administering provider
	 * @param adminProvider the administering provider
	 */
	@ComesFrom(path = &quot;Immunization.performer.actor.Practitioner&quot;, field = 10, comment = &quot;Administering Provider&quot;)
	public void setAdministeringProvider(Practitioner adminProvider) {
<span class="fc bfc" id="L168" title="All 2 branches covered.">		if (izDetail.hasImmunization()) {</span>
<span class="fc" id="L169">			addResource(adminProvider);</span>
<span class="fc" id="L170">			Reference ref = ParserUtils.toReference(adminProvider, izDetail.immunization, &quot;performer&quot;, &quot;practitioner&quot;);</span>
<span class="fc" id="L171">			ImmunizationPerformerComponent perf = izDetail.immunization.addPerformer().setActor(ref);</span>
<span class="fc" id="L172">			perf.setFunction(Codes.ADMIN_PROVIDER_FUNCTION_CODE);</span>
		}
<span class="fc" id="L174">	}</span>

	/*
	11	RXA-11	Administered-at Location	LA2	0	1												
	27	RXA-27	Administer-at	PL	0	1				Immunization.location(Immunization.Location)		Reference(Immunization.Location)	0	1	PL[Location]			
	*/
	/**
	 * Set the administered at location
	 * @param administerAt the administered at location
	 */
	@ComesFrom(path = &quot;Immunization.location&quot;, field = 11, comment = &quot;Administered-at Location&quot;)
	@ComesFrom(path = &quot;Immunization.location&quot;, field = 27, comment = &quot;Administer-at&quot;)
	public void setAdministerAt(Location administerAt) {
<span class="fc bfc" id="L187" title="All 2 branches covered.">		if (izDetail.hasImmunization()) {</span>
			// We don't need to check for location already being created.
			// A use of RXA-27 will likely not use, or just duplicate value in RXA-11
			// since few HL7 V2 versions have both (RXA-11 withdrawl started 
			// when RXA-27 introduced in V2.6).
<span class="fc" id="L192">			addResource(administerAt);</span>
<span class="fc" id="L193">			izDetail.immunization.setLocation(ParserUtils.toReference(administerAt, izDetail.immunization, &quot;location&quot;));</span>
		}
<span class="fc" id="L195">	}</span>

	/*
	28	RXA-28	Administered-at Address	XAD	0	1				Immunization.location(Immunization.Location.address)		Immunization.Address	0	1	XAD[Address]			
	*/
	/**
	 * Set the administered at location address
	 * @param administerAtAddress the administered at location address
	 */
	@ComesFrom(path = &quot;Immunization.location.Location.address&quot;, field = 28, comment = &quot;Administered-at Address&quot;)
	public void setAdministerAtAddress(Address administerAtAddress) {
<span class="nc bnc" id="L206" title="All 2 branches missed.">		if (izDetail.hasImmunization()) {</span>
<span class="nc" id="L207">			Reference locRef = izDetail.immunization.getLocation();</span>
<span class="nc" id="L208">			Location location = null;</span>
<span class="nc bnc" id="L209" title="All 2 branches missed.">			if (locRef == null) {</span>
<span class="nc" id="L210">				location = createResource(Location.class);</span>
<span class="nc" id="L211">				izDetail.immunization.setLocation(ParserUtils.toReference(location, izDetail.immunization, &quot;location&quot;));</span>
			} else {
<span class="nc" id="L213">				location = ParserUtils.getResource(Location.class, locRef);</span>
			}
<span class="nc" id="L215">			location.setAddress(administerAtAddress);</span>
		}
<span class="nc" id="L217">	}</span>

	/*
	15	RXA-15	Substance Lot Number	ST	0	-1				Immunization.lotNumber		Immunization.string	0	1				
	*/
	/**
	 * Set the lot number
	 * @param lotNumber lot number
	 */
	@ComesFrom(path = &quot;Immunization.lotNumber&quot;, field = 15, comment = &quot;Substance Lot Number&quot;)
	public void setLotNumber(StringType lotNumber) {
<span class="fc bfc" id="L228" title="All 2 branches covered.">		if (izDetail.hasImmunization()) {</span>
<span class="fc" id="L229">			izDetail.immunization.setLotNumberElement(lotNumber);</span>
		}
<span class="fc" id="L231">	}</span>
	
	/*
	16	RXA-16	Substance Expiration Date	DTM	0	-1				Immunization.expirationDate		Immunization.date	0	1				
	*/
	/**
	 * Set the expiration date
	 * @param expiration the expiration date 
	 */
	@ComesFrom(path = &quot;Immunization.expirationDate&quot;, field = 16, comment = &quot;Substance Expiration Date&quot;)
	public void setExpirationDate(DateType expiration) {
<span class="pc bpc" id="L242" title="1 of 2 branches missed.">		if (izDetail.hasImmunization()) {</span>
<span class="fc" id="L243">			izDetail.immunization.setExpirationDateElement(expiration);</span>
		}
<span class="fc" id="L245">	}</span>
	
	/*
	17	RXA-17	Substance Manufacturer Name	CWE	0	-1				Immunization.manufacturer(Immunization.Organization)		Reference(Immunization.Organization)	0	1	CWE[Organization]			
	*/
	/**
	 * Set the manufacturing organization from the MVX or Table 0227 code
	 * @param manufacturer	The manufacturing organization
	 */
	@ComesFrom(path = &quot;Immunization.manufacturer.Organization&quot;, field = 17, table = &quot;0227&quot;, comment = &quot;Substance Manufacturer Name&quot;)
	public void setManufacturer(CodeableConcept manufacturer) {
<span class="fc bfc" id="L256" title="All 2 branches covered.">		if (izDetail.hasImmunization()) {</span>
<span class="fc" id="L257">			Organization mOrg = new Organization();</span>
			// Convert a code to an Organization name and identifier
<span class="fc bfc" id="L259" title="All 2 branches covered.">			for (Coding coding: manufacturer.getCoding()) {</span>
<span class="fc" id="L260">				String system = coding.getSystem();</span>
<span class="pc bpc" id="L261" title="3 of 4 branches missed.">				if (Systems.MVX.equals(system) || Mapping.v2Table(&quot;0227&quot;).equals(system)) {</span>
<span class="pc bpc" id="L262" title="1 of 2 branches missed.">					if (coding.hasDisplay()) {</span>
<span class="fc" id="L263">						mOrg.setName(coding.getDisplay());</span>
					}
<span class="fc" id="L265">					mOrg.addIdentifier(new Identifier().setSystem(system).setValue(coding.getCode()));</span>
				}
<span class="fc" id="L267">			}</span>
<span class="pc bpc" id="L268" title="3 of 4 branches missed.">			if (mOrg.hasName() || mOrg.hasIdentifier()) {</span>
<span class="fc" id="L269">				addResource(mOrg);</span>
			}
<span class="fc" id="L271">			izDetail.immunization.setManufacturer(ParserUtils.toReference(mOrg, izDetail.immunization, &quot;manufacturer&quot;));</span>
		}
<span class="fc" id="L273">	}</span>
	
	/*
	18	RXA-18	Substance/Treatment Refusal Reason	CWE	0	-1				Immunization.statusReason		Immunization.CodeableConcept	0	1	CWE[CodeableConcept]			
	*/
	/**
	 * Set the reason for refusal
	 * @param substanceTreatmentRefusalReason the reason for refusal
	 */
	@ComesFrom(path = &quot;Immunization.statusReason&quot;, field = 18, comment = &quot;Substance/Treatment Refusal Reason&quot;)
	public void setSubstanceTreatmentRefusalReason(CodeableConcept substanceTreatmentRefusalReason) {
<span class="pc bpc" id="L284" title="1 of 2 branches missed.">		if (izDetail.hasImmunization()) {</span>
<span class="fc" id="L285">			izDetail.immunization.setStatus(ImmunizationStatus.NOTDONE);</span>
<span class="fc" id="L286">			izDetail.immunization.setStatusReason(substanceTreatmentRefusalReason);</span>
		}
<span class="fc" id="L288">	}</span>
	
	/*
	19	RXA-19	Indication	CWE	0	-1				Immunization.reasonCode		Immunization.CodeableConcept	0	-1	CWE[CodeableConcept]			
	*/
	/**
	 * Set the indication for vaccination
	 * @param indication the indication for vaccination
	 */
	@ComesFrom(path = &quot;Immunization.reasonCode&quot;, field = 19, comment = &quot;Indication&quot;)
	public void setIndication(CodeableConcept indication) {
<span class="pc bpc" id="L299" title="1 of 2 branches missed.">		if (izDetail.hasImmunization()) {</span>
<span class="fc" id="L300">			izDetail.immunization.addReasonCode(indication);</span>
<span class="nc bnc" id="L301" title="All 2 branches missed.">		} else if (izDetail.hasRecommendation()) {</span>
<span class="nc" id="L302">			recommendation.addForecastReason(indication);</span>
		}
<span class="fc" id="L304">	}</span>

	/*
	20	RXA-20	Completion Status	ID	0	1	IF RXA-21 NOT EQUALS &quot;D&quot;			Immunization.status		Immunization.code	1	1		CompletionStatus		
	20	RXA-20	Completion Status	ID	0	1	IF NOT VALUED AND RXA-21 NOT EQUALS &quot;D&quot;			Immunization.status		Immunization.code	1	1			&quot;completed&quot;	
	21	RXA-21	Action Code – RXA	ID	0	1	IF RXA-21 EQUALS &quot;D&quot;			Immunization.status		Immunization.code	1	1			&quot;entered-in-error&quot;	
	*/
	/**
	 * Set the completion status
	 * @param completionStatus the completion status
	 */
	@ComesFrom(path = &quot;Immunization.status&quot;, field = 20, table = &quot;0322&quot;, map = &quot;ImmunizationStatus&quot;, comment = &quot;Completion Status&quot;)
	@ComesFrom(path = &quot;Immunization.status&quot;, field = 21, table = &quot;0323&quot;, map = &quot;ImmunizationStatus&quot;, comment = &quot;Action Code – RXA&quot;)
	public void setCompletionStatus(Coding completionStatus) {
<span class="fc bfc" id="L318" title="All 2 branches covered.">		if (izDetail.hasImmunization()) {</span>
<span class="pc bpc" id="L319" title="1 of 2 branches missed.">			if (!completionStatus.hasCode()) {</span>
<span class="nc" id="L320">				return;</span>
			}
<span class="fc" id="L322">			String value = StringUtils.right(completionStatus.getSystem(), 4) + &quot;|&quot; + completionStatus.getCode();</span>
<span class="fc" id="L323">			ImmunizationStatus code = null;</span>
<span class="fc bfc" id="L324" title="All 3 branches covered.">			switch (value) {</span>
			case &quot;0322|CP&quot;, &quot;0322|PA&quot;, &quot;0323|A&quot;, &quot;0323|U&quot;:
<span class="fc" id="L326">				code = ImmunizationStatus.COMPLETED;</span>
<span class="fc" id="L327">				break;</span>
			case &quot;0322|NA&quot;, &quot;0322|RE&quot;, &quot;0323|D&quot;:
<span class="fc" id="L329">				code = ImmunizationStatus.NOTDONE;</span>
<span class="fc" id="L330">				break;</span>
			default:
				break;
			}
			// RXA-22 field in can be D, which is a delete (entered-in-error), 
			// that overrides first, so we don't check for conflicts
<span class="fc" id="L336">			izDetail.immunization.setStatus(code);</span>
		}
<span class="fc" id="L338">	}</span>

	/*
	22	RXA-22	System Entry Date/Time	DTM	0	1	IF RXA-21 EQUALS &quot;A&quot;			Immunization.recorded		Immunization.dateTime	0	1				
	*/
	/**
	 * Set the recorded date time
	 * @param systemEntryDateTime the recorded date time
	 */
	@ComesFrom(path = &quot;Immunization.recorded&quot;, field = 22, comment = &quot;System Entry Date/Time&quot;)
	public void setSystemEntryDateTime(DateTimeType systemEntryDateTime) {
<span class="nc bnc" id="L349" title="All 2 branches missed.">		if (izDetail.hasImmunization()) {</span>
<span class="nc" id="L350">			izDetail.immunization.setRecordedElement(systemEntryDateTime);</span>
<span class="nc bnc" id="L351" title="All 2 branches missed.">		} else if (izDetail.hasRecommendation()) {</span>
<span class="nc" id="L352">			izDetail.immunizationRecommendation.setDateElement(systemEntryDateTime);</span>
		}
<span class="nc" id="L354">	}</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.13.202504020838</span></div></body></html>