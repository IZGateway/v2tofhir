<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MRGParser.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">HL7 Version 2 to FHIR Conversion</a> &gt; <a href="index.source.html" class="el_package">gov.cdc.izgw.v2tofhir.segment</a> &gt; <span class="el_source">MRGParser.java</span></div><h1>MRGParser.java</h1><pre class="source lang-java linenums">package gov.cdc.izgw.v2tofhir.segment;

import java.util.ArrayList;
import java.util.List;

import org.hl7.fhir.instance.model.api.IBaseResource;
import org.hl7.fhir.r4.model.Account;
import org.hl7.fhir.r4.model.Encounter;
import org.hl7.fhir.r4.model.HumanName;
import org.hl7.fhir.r4.model.Identifier;
import org.hl7.fhir.r4.model.Patient;
import gov.cdc.izgw.v2tofhir.annotation.ComesFrom;
import gov.cdc.izgw.v2tofhir.annotation.Produces;
import gov.cdc.izgw.v2tofhir.converter.MessageParser;
import gov.cdc.izgw.v2tofhir.utils.ParserUtils;
import lombok.extern.slf4j.Slf4j;

/**
 * Parser for MRG Segments
 * 
 * The MRG segment populates a Patient resource with identifiers and demographics for
 * a patient which would need to be merged into a single patiennt. 
 * 
 * @author Audacious Inquiry
 */
@Produces(segment=&quot;MRG&quot;, resource=Patient.class, extra = { Account.class, Encounter.class })
<span class="fc" id="L27">@Slf4j</span>
public class MRGParser extends AbstractSegmentParser {
	private Patient patient;
	private Account account;
	private Encounter encounter;
	
<span class="fc" id="L33">	private static List&lt;FieldHandler&gt; fieldHandlers = new ArrayList&lt;&gt;();</span>

	static {
<span class="fc" id="L36">		log.debug(&quot;{} loaded&quot;, MRGParser.class.getName());</span>
<span class="fc" id="L37">	}</span>
	
	/**
	 * Construct a new MRGParser
	 * 
	 * @param messageParser	The messageParser to construct this parser for.
	 */
	public MRGParser(MessageParser messageParser) {
<span class="fc" id="L45">		super(messageParser, &quot;MRG&quot;);</span>
<span class="fc bfc" id="L46" title="All 2 branches covered.">		if (fieldHandlers.isEmpty()) {</span>
<span class="fc" id="L47">			FieldHandler.initFieldHandlers(this, fieldHandlers);</span>
		}
<span class="fc" id="L49">	}</span>

	
	@Override
	public List&lt;FieldHandler&gt; getFieldHandlers() {
<span class="fc" id="L54">		return fieldHandlers;</span>
	}
	
	@Override
	public IBaseResource setup() {
		// The MRG segment is used with an existing patient recorded
		// in the PID segment, so get the most recently created Patient
		// resource.
<span class="fc" id="L62">		patient = getLastResource(Patient.class);</span>
<span class="fc bfc" id="L63" title="All 2 branches covered.">		if (patient == null) {</span>
<span class="fc" id="L64">			patient = createResource(Patient.class);</span>
		}
<span class="fc" id="L66">		account = null;</span>
<span class="fc" id="L67">		encounter = null;</span>
<span class="fc" id="L68">		return patient;</span>
	}
	
	/*
	The MRG segment provides receiving applications with information necessary to initiate the merging of patient data as well as groups of records. It is intended that this segment be used throughout the Standard to allow the merging of registration, accounting, and clinical records within specific applications.

	FIELD	LENGTH	DATA TYPE	OPTIONALITY	REPEATABILITY	TABLE	
	MRG.1 - Prior Patient Identifier List	250	CX	R	∞		
	MRG.2 - Prior Alternate Patient ID	250	CX	B	∞		
	MRG.3 - Prior Patient Account Number	250	CX	O	-		
	MRG.4 - Prior Patient ID	250	CX	B	-		
	MRG.5 - Prior Visit Number	250	CX	O	-		
	MRG.6 - Prior Alternate Visit ID	250	CX	O	-		
	MRG.7 - Prior Patient Name	250	XPN
	*/
	/**
	 * Add a patient identifier
	 * @param ident the patient identifier
	 */
	@ComesFrom(path=&quot;Patient.identifier&quot;, field = 1, comment = &quot;Prior Patient Identifier List&quot;)
	@ComesFrom(path=&quot;Patient.identifier&quot;, field = 2, comment = &quot;Prior Alternate Patient ID&quot;)
	@ComesFrom(path=&quot;Patient.identifier&quot;, field = 4, comment = &quot;Prior Patient ID&quot;)
	public void addPatientIdentifier(Identifier ident) {
<span class="fc" id="L91">		patient.addIdentifier(ident);</span>
<span class="fc" id="L92">	}</span>
	
	/**
	 * Add a patient account identifier
	 * Creates a new account.  Adds a reference from the Encounter to the account.
	 * Adds a reference from the encounter and the account to the patient as the subject.
	 * @param accountId	The account identifier
	 */
	@ComesFrom(path=&quot;Account.identifier&quot;, field = 3, comment = &quot;Prior Patient Account Number&quot;)
	public void addPatientAccount(Identifier accountId) {
<span class="nc" id="L102">		account = createResource(Account.class);</span>
<span class="nc" id="L103">		account.addIdentifier(accountId);</span>
<span class="nc" id="L104">		account.addSubject(ParserUtils.toReference(patient, account, &quot;subject&quot;, &quot;patient&quot;));</span>
<span class="nc" id="L105">		account.getMeta().addTag();</span>
<span class="nc" id="L106">		encounter = getEncounter();</span>
<span class="nc" id="L107">		encounter.addAccount(ParserUtils.toReference(account, encounter, &quot;account&quot;));</span>
<span class="nc" id="L108">	}</span>

	/**
	 * Create or return the encounter associated with this segment.
	 * If an encounter has already been created, returns it. Otherwise
	 * creates the encounter and connects the encounter to the patient.
	 * @return The encounter associated with this segment
	 */
	private Encounter getEncounter() {
<span class="nc bnc" id="L117" title="All 2 branches missed.">		if (encounter == null) {</span>
<span class="nc" id="L118">			encounter = createResource(Encounter.class);</span>
<span class="nc" id="L119">			encounter.setSubject(ParserUtils.toReference(patient, encounter, &quot;subject&quot;, &quot;patient&quot;));</span>
		}
<span class="nc" id="L121">		return encounter;</span>
	}
	
	/**
	 * Add an identifier to the encounter.
	 * Creates or gets the existing encounter and adds the identifier to it.
	 * @param encounterId The encounter identifier.
	 */
	@ComesFrom(path=&quot;Encounter.identifier&quot;, field = 5, comment = &quot;Prior Visit Number&quot;)
	@ComesFrom(path=&quot;Encounter.identifier&quot;, field = 6, comment = &quot;Prior Alternate Visit ID&quot;)
	public void addEncounterIdentifier(Identifier encounterId) {
<span class="nc" id="L132">		encounter = getEncounter();</span>
<span class="nc" id="L133">		encounter.addIdentifier(encounterId);</span>
<span class="nc" id="L134">	}</span>
		
	/**
	 * Add the name to the patient.
	 * @param humanName The patient name
	 */
	@ComesFrom(path=&quot;Patient.name&quot;, field = 7, comment = &quot;Patient Name&quot;)
	public void addPatientName(HumanName humanName) {
<span class="nc" id="L142">		patient.addName();</span>
<span class="nc" id="L143">	}</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.13.202504020838</span></div></body></html>