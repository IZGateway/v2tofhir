<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>IzDetail.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">HL7 Version 2 to FHIR Conversion</a> &gt; <a href="index.source.html" class="el_package">gov.cdc.izgw.v2tofhir.segment</a> &gt; <span class="el_source">IzDetail.java</span></div><h1>IzDetail.java</h1><pre class="source lang-java linenums">package gov.cdc.izgw.v2tofhir.segment;

import java.util.List;

import org.hl7.fhir.r4.model.CanonicalType;
import org.hl7.fhir.r4.model.Coding;
import org.hl7.fhir.r4.model.DomainResource;
import org.hl7.fhir.r4.model.Immunization;
import org.hl7.fhir.r4.model.ImmunizationRecommendation;
import org.hl7.fhir.r4.model.ImmunizationRecommendation.ImmunizationRecommendationRecommendationComponent;
import org.hl7.fhir.r4.model.MessageHeader;
import org.hl7.fhir.r4.model.Organization;
import org.hl7.fhir.r4.model.Patient;

import ca.uhn.hl7v2.model.Segment;
import gov.cdc.izgw.v2tofhir.converter.MessageParser;
import gov.cdc.izgw.v2tofhir.utils.Mapping;
import gov.cdc.izgw.v2tofhir.utils.ParserUtils;

/**
 * This class is used for parsers that may generate an Immunization or ImmunizationRecommendation
 * resources based on message context clues (e.g., Profiles used or event types).
 * 
 * @author Audacious Inquiry
 */

public class IzDetail {
	private final MessageParser mp;
	
<span class="fc" id="L30">	private Boolean hasImmunization = null;</span>
	Immunization immunization;
	
<span class="fc" id="L33">	private Boolean hasImmunizationRecommendation = null;</span>
	ImmunizationRecommendation immunizationRecommendation;
	
	Organization requestingOrganization;
	private Segment segment;
	
<span class="fc" id="L39">	private IzDetail(MessageParser mp) {</span>
<span class="fc" id="L40">		this.mp = mp;</span>
<span class="fc" id="L41">	}</span>
	static IzDetail get(MessageParser mp) {
<span class="fc" id="L43">		IzDetail detail = mp.getContext().getProperty(IzDetail.class);</span>
<span class="fc bfc" id="L44" title="All 2 branches covered.">		if (detail == null) {</span>
<span class="fc" id="L45">			detail = new IzDetail(mp);</span>
<span class="fc" id="L46">			mp.getContext().setProperty(detail);</span>
		}
<span class="fc" id="L48">		return detail;</span>
	}
	
	/**
	 * Strictly to support testing
	 * @param mp	The message parser used for testing
	 */
	public static void testWith(MessageParser mp) {
<span class="fc" id="L56">		IzDetail detail = mp.getContext().getProperty(IzDetail.class);</span>
<span class="pc bpc" id="L57" title="1 of 2 branches missed.">		if (detail == null) {</span>
<span class="fc" id="L58">			detail = new IzDetail(mp);</span>
<span class="fc" id="L59">			detail.hasImmunization = true;</span>
<span class="fc" id="L60">			detail.hasImmunizationRecommendation = false;</span>
<span class="fc" id="L61">			detail.immunization = mp.createResource(Immunization.class);</span>
<span class="fc" id="L62">			MessageHeader mh = mp.getFirstResource(MessageHeader.class);</span>
<span class="pc bpc" id="L63" title="3 of 4 branches missed.">			if (mh != null &amp;&amp; detail.hasImmunization()) {</span>
<span class="nc" id="L64">				mh.addFocus(ParserUtils.toReference(detail.immunization, mh, &quot;focus&quot;));</span>
			}
<span class="fc" id="L66">			Patient p = mp.getLastResource(Patient.class);</span>
<span class="pc bpc" id="L67" title="1 of 2 branches missed.">			if (p != null) {</span>
<span class="nc" id="L68">				detail.immunization.setPatient(ParserUtils.toReference(detail.immunization, p, &quot;patient&quot;));</span>
			}
<span class="fc" id="L70">			mp.getContext().setProperty(detail);</span>
		}
<span class="fc" id="L72">	}</span>

	boolean hasRecommendation() {
<span class="fc bfc" id="L75" title="All 2 branches covered.">		if (hasImmunizationRecommendation != null) {</span>
<span class="fc" id="L76">			return hasImmunizationRecommendation;</span>
		}
<span class="fc" id="L78">		checkForImmunization();</span>
<span class="fc" id="L79">		return hasImmunizationRecommendation;</span>
	}
	
	boolean hasImmunization() {
<span class="pc bpc" id="L83" title="1 of 2 branches missed.">		if (hasImmunization != null) {</span>
<span class="fc" id="L84">			return hasImmunization;</span>
		}
<span class="nc" id="L86">		checkForImmunization();</span>
<span class="nc" id="L87">		return hasImmunization;</span>
	}
	
	private void checkForImmunization() {
		// Look at the RXA, Profile and Message Header
<span class="fc" id="L92">		hasImmunization = Boolean.FALSE;</span>
<span class="fc" id="L93">		hasImmunizationRecommendation = Boolean.FALSE;</span>
<span class="fc" id="L94">		immunization = null;</span>
<span class="fc" id="L95">		immunizationRecommendation = null;</span>

		// RXA couldn't be checked, fall back to MSH profile.
<span class="fc bfc" id="L98" title="All 2 branches covered.">		for (CanonicalType url: mp.getBundle().getMeta().getProfile()) {</span>
<span class="fc bfc" id="L99" title="All 4 branches covered.">			if (&quot;CDCPHINVS#Z32&quot;.equals(url.getValue()) || &quot;CDCPHINVS#Z22&quot;.equals(url.getValue())) {</span>
				// An RSP_K11 conforming to Z32, or a VXU_V04 conforming to Z22 
				// will always have Immunization resources
<span class="fc" id="L102">				hasImmunization = Boolean.TRUE;</span>
<span class="fc" id="L103">				hasImmunizationRecommendation = Boolean.FALSE;</span>
<span class="fc" id="L104">				return;</span>
			} 
			
<span class="pc bpc" id="L107" title="1 of 2 branches missed.">			if (&quot;CDCPHINVS#Z42&quot;.equals(url.getValue())) {</span>
				// Whereas an RSP_K11 conforming to a Z42 will have an ImmunizationRecommendation or 
				// an Immunization.  We must look at the RXA to determine which of these two cases
				// are possible.  If RXA-5 = 998^No Vaccine Administered^CVX, then it's a recommendation.
<span class="fc" id="L111">				hasImmunization = Boolean.FALSE;</span>
<span class="fc" id="L112">				hasImmunizationRecommendation = Boolean.TRUE;</span>
<span class="fc" id="L113">				return;</span>
			}
<span class="nc" id="L115">		}</span>
		
		// Nope, still haven't figured it out.
<span class="fc" id="L118">		MessageHeader mh = mp.getFirstResource(MessageHeader.class);</span>
<span class="pc bpc" id="L119" title="1 of 2 branches missed.">		if (mh == null) {</span>
			// there is no message header, so not an immunization or recommendation.
<span class="fc" id="L121">			hasImmunization = Boolean.FALSE;</span>
<span class="fc" id="L122">			hasImmunizationRecommendation = Boolean.FALSE;</span>
<span class="fc" id="L123">			return;</span>
		}
		
<span class="nc bnc" id="L126" title="All 2 branches missed.">		for (Coding tag: mh.getMeta().getTag()) {</span>
<span class="nc bnc" id="L127" title="All 4 branches missed.">			if (Mapping.v2Table(&quot;0076&quot;).equals(tag.getSystem()) &amp;&amp; &quot;VXU&quot;.equals(tag.getCode())) {</span>
				// VXU, so must be an Immunization
<span class="nc" id="L129">				hasImmunization = Boolean.TRUE;</span>
<span class="nc" id="L130">				hasImmunizationRecommendation = Boolean.FALSE;</span>
			}
<span class="nc" id="L132">		}</span>
<span class="nc" id="L133">	}</span>
	
	/**
	 * Looks at the RXA to see whether this is an Immunization or ImmunizationRecommendation
	 * TODO: Consider how to integrate this check, or remove it
	 * @return	true if RXA was checked, false if it could not be checked.
	 */
	@SuppressWarnings(&quot;unused&quot;)
	private boolean checkRXA() {
		// Set default value
<span class="nc" id="L143">		boolean defaulted = true;</span>
<span class="nc" id="L144">		hasImmunizationRecommendation = true;</span>
<span class="nc bnc" id="L145" title="All 2 branches missed.">		if (segment != null) {</span>
<span class="nc" id="L146">			Segment rxa = null;</span>
<span class="nc bnc" id="L147" title="All 2 branches missed.">			if (&quot;ORC&quot;.equals(segment.getName())) {</span>
<span class="nc" id="L148">				rxa = ParserUtils.getFollowingSegment(segment, &quot;RXA&quot;);</span>
<span class="nc bnc" id="L149" title="All 2 branches missed.">			} else if (&quot;RXA&quot;.equals(segment.getName())) {</span>
<span class="nc" id="L150">				rxa = segment;</span>
			}
<span class="nc bnc" id="L152" title="All 2 branches missed.">			if (rxa == null) {</span>
				// ORC but NO RXA
<span class="nc" id="L154">				hasImmunization = hasImmunizationRecommendation = false;</span>
<span class="nc" id="L155">				return false;</span>
			}
<span class="nc" id="L157">			hasImmunizationRecommendation = &quot;998&quot;.equals(ParserUtils.toString(rxa, 5));</span>
<span class="nc" id="L158">			defaulted = false;</span>
		} 
		// else No segment, but known to be a Z42, assume testing for ImmunizationRecommendation
<span class="nc bnc" id="L161" title="All 2 branches missed.">		hasImmunization = !hasImmunizationRecommendation;</span>
<span class="nc bnc" id="L162" title="All 2 branches missed.">		return !defaulted;</span>
	}
	/**
	 * Get the recommendation component.
	 * @return The recommendation from the ImmunizationRecommendation resource.
	 */
	public ImmunizationRecommendationRecommendationComponent getRecommendation() {
<span class="pc bpc" id="L169" title="1 of 2 branches missed.">		if (hasRecommendation()) {</span>
			// Get the recommendation created by the last RXA.
<span class="fc" id="L171">			List&lt;ImmunizationRecommendationRecommendationComponent&gt; l = immunizationRecommendation.getRecommendation();</span>
<span class="pc bpc" id="L172" title="1 of 2 branches missed.">			if (l.isEmpty()) {</span>
<span class="nc" id="L173">				return null;</span>
			}
<span class="fc" id="L175">			return l.get(l.size() - 1); </span>
		}
<span class="nc" id="L177">		return null;</span>
	}
	
	/**
	 * Initialize the resources on receipt of a new ORC or RXA segment. 
	 * @param initialize If true, created new resource always, not just if missing
	 * @param segment The segment currently being parsed
	 */
	public void initializeResources(boolean initialize, Segment segment) {
		// Create the necessary resources.
<span class="fc" id="L187">		DomainResource created = null;</span>
<span class="fc" id="L188">		Patient p = mp.getLastResource(Patient.class);</span>
<span class="fc" id="L189">		this.segment = segment;</span>
<span class="fc bfc" id="L190" title="All 2 branches covered.">		if (initialize) {</span>
<span class="fc" id="L191">			checkForImmunization();</span>
		}
<span class="fc bfc" id="L193" title="All 4 branches covered.">		if (hasRecommendation() &amp;&amp; immunizationRecommendation == null) {</span>
<span class="fc" id="L194">			created = immunizationRecommendation = mp.createResource(ImmunizationRecommendation.class);</span>
<span class="pc bpc" id="L195" title="1 of 2 branches missed.">			if (p != null) {</span>
<span class="fc" id="L196">				immunizationRecommendation.setPatient(ParserUtils.toReference(p, immunizationRecommendation, &quot;patient&quot;));</span>
			}
		}
<span class="fc bfc" id="L199" title="All 4 branches covered.">		if (hasImmunization() &amp;&amp; immunization == null) {</span>
<span class="fc" id="L200">			created = immunization = mp.createResource(Immunization.class);</span>
<span class="pc bpc" id="L201" title="1 of 2 branches missed.">			if (p != null) {</span>
<span class="fc" id="L202">				immunization.setPatient(ParserUtils.toReference(p, immunization, &quot;patient&quot;));</span>
			}
		}
<span class="fc bfc" id="L205" title="All 2 branches covered.">		if (created != null) {</span>
<span class="fc" id="L206">			MessageHeader mh = mp.getFirstResource(MessageHeader.class);</span>
<span class="pc bpc" id="L207" title="1 of 2 branches missed.">			if (mh != null) {</span>
<span class="fc" id="L208">				mh.addFocus(ParserUtils.toReference(created, mh, &quot;focus&quot;));</span>
			}
		}
<span class="fc" id="L211">	}</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.13.202504020838</span></div></body></html>