<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>QPDParser.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">HL7 Version 2 to FHIR Conversion</a> &gt; <a href="index.source.html" class="el_package">gov.cdc.izgw.v2tofhir.segment</a> &gt; <span class="el_source">QPDParser.java</span></div><h1>QPDParser.java</h1><pre class="source lang-java linenums">package gov.cdc.izgw.v2tofhir.segment;

import java.lang.reflect.InvocationTargetException;
import java.net.URLEncoder;
import java.nio.charset.StandardCharsets;
import java.util.ArrayList;
import java.util.List;

import org.apache.commons.lang3.StringUtils;
import org.hl7.fhir.instance.model.api.IBase;
import org.hl7.fhir.instance.model.api.IBaseResource;
import org.hl7.fhir.r4.model.Address;
import org.hl7.fhir.r4.model.BaseDateTimeType;
import org.hl7.fhir.r4.model.BooleanType;
import org.hl7.fhir.r4.model.CodeType;
import org.hl7.fhir.r4.model.CodeableConcept;
import org.hl7.fhir.r4.model.Coding;
import org.hl7.fhir.r4.model.ContactPoint;
import org.hl7.fhir.r4.model.DateType;
import org.hl7.fhir.r4.model.HumanName;
import org.hl7.fhir.r4.model.Identifier;
import org.hl7.fhir.r4.model.InstantType;
import org.hl7.fhir.r4.model.MessageHeader;
import org.hl7.fhir.r4.model.Parameters;
import org.hl7.fhir.r4.model.PositiveIntType;
import org.hl7.fhir.r4.model.StringType;
import org.hl7.fhir.r4.model.Bundle.BundleEntryComponent;
import org.hl7.fhir.r4.model.Bundle.BundleEntryRequestComponent;
import org.hl7.fhir.r4.model.Bundle.BundleEntryResponseComponent;
import org.hl7.fhir.r4.model.Bundle.HTTPVerb;

import ca.uhn.hl7v2.HL7Exception;
import ca.uhn.hl7v2.model.GenericComposite;
import ca.uhn.hl7v2.model.Message;
import ca.uhn.hl7v2.model.Segment;
import ca.uhn.hl7v2.model.Type;
import ca.uhn.hl7v2.model.Varies;
import gov.cdc.izgw.v2tofhir.annotation.Produces;
import gov.cdc.izgw.v2tofhir.converter.DatatypeConverter;
import gov.cdc.izgw.v2tofhir.converter.MessageParser;
import gov.cdc.izgw.v2tofhir.utils.IzQuery;
import gov.cdc.izgw.v2tofhir.utils.ParserUtils;
import gov.cdc.izgw.v2tofhir.utils.V2Utils;
import lombok.extern.slf4j.Slf4j;

/**
 * The QPD Parser generates a Parameters resource documenting the QPD parameters found in QPD-3 to QPD-*
 * 
 * For queries (message type of QBP):
 * 
 * The Bundle.entry containing this Parameters resource in Bundle.entry.resource will contain a 
 * Bundle.entry.request element with the method set to GET and the url set to the FHIR _search URL which would perform the query.
 * 
 * For responses to queries (message type of RSP):
 * 
 * The Bundle.entry containing this Parameters resource in Bundle.entry.resource will contain a 
 * Bundle.entry.response element with the location set to the FHIR _search URL which would perform the query.
 *
 * @author Audacious Inquiry
 *
 */
@Produces(segment=&quot;QPD&quot;, resource=Parameters.class)
<span class="fc" id="L63">@Slf4j</span>
public class QPDParser extends AbstractSegmentParser {
	private Parameters params;
	private MessageHeader mh;
<span class="fc" id="L67">	private static List&lt;FieldHandler&gt; fieldHandlers = new ArrayList&lt;&gt;();</span>
	static {
<span class="fc" id="L69">		log.debug(&quot;{} loaded&quot;, QPDParser.class.getName());</span>
	}
	/**
	 * Construct a new QPD Parser for the given messageParser.
	 * 
	 * @param messageParser The messageParser using this QPDParser
	 */
	public QPDParser(MessageParser messageParser) {
<span class="fc" id="L77">		super(messageParser, &quot;QPD&quot;);</span>
<span class="pc bpc" id="L78" title="1 of 2 branches missed.">		if (fieldHandlers.isEmpty()) {</span>
<span class="fc" id="L79">			FieldHandler.initFieldHandlers(this, fieldHandlers);</span>
		}
<span class="fc" id="L81">	}</span>
	
	@Override
	public List&lt;FieldHandler&gt; getFieldHandlers() {
<span class="nc" id="L85">		return fieldHandlers;</span>
	}
	
<span class="fc" id="L88">	private static final String[][] v2QueryNames = {</span>
		{ 	&quot;Z34&quot;, &quot;Request Immunization History&quot;, &quot;CDCPHINVS&quot;, &quot;Immunization&quot;,
			// QPD Parameter Name, V2 Type to convert from, FHIR Query Parameter, FHIR Type to convert parmater to
<span class="fc" id="L91">			&quot;PatientList&quot;, &quot;CX&quot;, IzQuery.PATIENT_LIST, Identifier.class.getSimpleName(),</span>
<span class="fc" id="L92">			&quot;PatientName&quot;, &quot;XPN&quot;, &quot;patient.name&quot;, HumanName.class.getSimpleName(), </span>
<span class="fc" id="L93">			&quot;PatientMotherMaidenName&quot;, &quot;XPN&quot;, IzQuery.PATIENT_MOTHERS_MAIDEN_NAME, HumanName.class.getSimpleName(), </span>
<span class="fc" id="L94">			&quot;PatientDateOfBirth&quot;, &quot;TS&quot;, IzQuery.PATIENT_BIRTHDATE, DateType.class.getSimpleName(),</span>
<span class="fc" id="L95">			&quot;PatientSex&quot;, &quot;IS&quot;, IzQuery.PATIENT_GENDER, CodeType.class.getSimpleName(), </span>
<span class="fc" id="L96">			&quot;PatientAddress&quot;, &quot;XAD&quot;, IzQuery.PATIENT_ADDRESS, Address.class.getSimpleName(), </span>
<span class="fc" id="L97">			&quot;PatientHomePhone&quot;, &quot;XTN&quot;, IzQuery.PATIENT_HOMEPHONE, ContactPoint.class.getSimpleName(),</span>
<span class="fc" id="L98">			&quot;PatientMultipleBirthIndicator&quot;, IzQuery.PATIENT_MULTIPLE_BIRTH_INDICATOR, null, BooleanType.class.getSimpleName(),</span>
<span class="fc" id="L99">			&quot;PatientBirthOrder&quot;, &quot;NM&quot;, IzQuery.PATIENT_MULTIPLE_BIRTH_ORDER, PositiveIntType.class.getSimpleName(),</span>
<span class="fc" id="L100">			&quot;ClientLastUpdateDate&quot;, &quot;TS&quot;, null, InstantType.class.getSimpleName(),</span>
<span class="fc" id="L101">			&quot;ClientLastUpdateFacility&quot;, &quot;HD&quot;, null, Identifier.class.getSimpleName()</span>
		},
		{	&quot;Z44&quot;, &quot;Request Evaluated History and Forecast&quot;, &quot;CDCPHINVS&quot;, &quot;ImmunizationRecommendation&quot;,
<span class="fc" id="L104">			&quot;PatientList&quot;, &quot;CX&quot;, IzQuery.PATIENT_LIST, Identifier.class.getSimpleName(),</span>
<span class="fc" id="L105">			&quot;PatientName&quot;, &quot;XPN&quot;, &quot;patient.name&quot;, HumanName.class.getSimpleName(), </span>
<span class="fc" id="L106">			&quot;PatientMotherMaidenName&quot;, &quot;XPN&quot;, IzQuery.PATIENT_MOTHERS_MAIDEN_NAME, HumanName.class.getSimpleName(), </span>
<span class="fc" id="L107">			&quot;PatientDateOfBirth&quot;, &quot;TS&quot;, IzQuery.PATIENT_BIRTHDATE, DateType.class.getSimpleName(),</span>
<span class="fc" id="L108">			&quot;PatientSex&quot;, &quot;IS&quot;, IzQuery.PATIENT_GENDER, CodeType.class.getSimpleName(), </span>
<span class="fc" id="L109">			&quot;PatientAddress&quot;, &quot;XAD&quot;, IzQuery.PATIENT_ADDRESS, Address.class.getSimpleName(), </span>
<span class="fc" id="L110">			&quot;PatientHomePhone&quot;, &quot;XTN&quot;, IzQuery.PATIENT_HOMEPHONE, ContactPoint.class.getSimpleName(),</span>
<span class="fc" id="L111">			&quot;PatientMultipleBirthIndicator&quot;, IzQuery.PATIENT_MULTIPLE_BIRTH_INDICATOR, null, BooleanType.class.getSimpleName(),</span>
<span class="fc" id="L112">			&quot;PatientBirthOrder&quot;, &quot;NM&quot;, IzQuery.PATIENT_MULTIPLE_BIRTH_ORDER, PositiveIntType.class.getSimpleName(),</span>
<span class="fc" id="L113">			&quot;ClientLastUpdateDate&quot;, &quot;TS&quot;, null, InstantType.class.getSimpleName(),</span>
<span class="fc" id="L114">			&quot;ClientLastUpdateFacility&quot;, &quot;HD&quot;, null, Identifier.class.getSimpleName()</span>
		},
		{	// IHE PDQ Query
			&quot;Q22&quot;, &quot;FindCandidates&quot;, &quot;HL7&quot;, &quot;Patient&quot;,
<span class="fc" id="L118">			&quot;PID.3&quot;, &quot;CX&quot;, &quot;identifier&quot;, Identifier.class.getSimpleName(),</span>
<span class="fc" id="L119">			&quot;PID.5&quot;, &quot;XPN&quot;, &quot;name&quot;, HumanName.class.getSimpleName(),</span>
<span class="fc" id="L120">			&quot;PID.6&quot;, &quot;XPN&quot;, &quot;mothersMaidenName&quot;, StringType.class.getSimpleName(),</span>
<span class="fc" id="L121">			&quot;PID.7&quot;, &quot;TS&quot;, &quot;birthdate&quot;, DateType.class.getSimpleName(),</span>
<span class="fc" id="L122">			&quot;PID.8&quot;, &quot;IS&quot;, &quot;gender&quot;, CodeType.class.getSimpleName(),</span>
<span class="fc" id="L123">			&quot;PID.11&quot;, &quot;XAD&quot;, &quot;address&quot;, Address.class.getSimpleName(),</span>
<span class="fc" id="L124">			&quot;PID.13&quot;, &quot;XTN&quot;, &quot;phone&quot;, ContactPoint.class.getSimpleName(),</span>
<span class="fc" id="L125">			&quot;PID.18&quot;, &quot;ID&quot;, null, Identifier.class.getSimpleName()</span>
		},
		{	// IHE PIX Query
<span class="fc" id="L128">			&quot;IHE PIX Query&quot;, &quot;&quot;, &quot;&quot;, Identifier.class.getSimpleName(),</span>
<span class="fc" id="L129">			&quot;Person Identifier&quot;, &quot;CX&quot;, &quot;identifier&quot;, Identifier.class.getSimpleName(), </span>
<span class="fc" id="L130">			&quot;What Domains Returned&quot;, &quot;CX&quot;, &quot;name&quot;, HumanName.class.getSimpleName()</span>
		}
	};
	
	public IBaseResource setup() {
<span class="fc" id="L135">		params = createResource(Parameters.class);</span>
<span class="fc" id="L136">		mh = this.getFirstResource(MessageHeader.class);</span>
<span class="fc" id="L137">		return params;</span>
	}
	
	@Override
	public IBase parse(Segment seg) {
<span class="fc" id="L142">		Type query = V2Utils.getField(seg, 1);</span>
<span class="fc" id="L143">		CodeableConcept queryName = DatatypeConverter.toCodeableConcept(query);</span>
<span class="pc bpc" id="L144" title="1 of 2 branches missed.">		if (queryName == null) {</span>
			try {
<span class="nc" id="L146">				getParser().warn(&quot;Cannot parse unnamed query for: &quot; + seg.encode());</span>
<span class="nc" id="L147">			} catch (HL7Exception e) {</span>
				// Ignore it.
<span class="nc" id="L149">			}</span>
<span class="nc" id="L150">			return null;</span>
		}
<span class="fc" id="L152">		IBase b = setup();</span>
		
<span class="fc" id="L154">		params.getMeta().addTag(queryName.getCodingFirstRep());</span>
		
<span class="fc" id="L156">		String queryTag = ParserUtils.toString(V2Utils.getField(seg, 2));</span>
<span class="fc" id="L157">		String[] parameters = getQueryParameters(queryName);</span>
<span class="fc" id="L158">		params.getMeta().addTag(&quot;QueryTag&quot;, queryTag, null);</span>

<span class="fc bfc" id="L160" title="All 2 branches covered.">		if (parameters.length == 0) {</span>
<span class="fc" id="L161">			getParser().warn(&quot;Cannot parse {} query&quot;, query);</span>
<span class="fc" id="L162">			return b;</span>
		}
<span class="fc" id="L164">		String request = getSearchRequest(seg, parameters);</span>
		
<span class="fc" id="L166">		BundleEntryComponent entry = (BundleEntryComponent) params.getUserData(BundleEntryComponent.class.getName());</span>
<span class="fc" id="L167">		Boolean isResponse = isResponse();</span>
<span class="pc bpc" id="L168" title="1 of 4 branches missed.">		if (entry != null &amp;&amp; Boolean.TRUE.equals(isResponse)) {</span>
			// Was this QPD in response to a query message, or was it the query itself.
<span class="fc" id="L170">			BundleEntryResponseComponent resp = entry.getResponse();</span>
<span class="fc" id="L171">			params.setUserData(BundleEntryResponseComponent.class.getName(), resp);</span>
<span class="fc" id="L172">			resp.setLocation(request);</span>
<span class="fc" id="L173">			resp.setLastModified(getBundle().getTimestamp());</span>
<span class="pc bpc" id="L174" title="1 of 4 branches missed.">		} else if (entry != null &amp;&amp; Boolean.FALSE.equals(isResponse)) {</span>
<span class="fc" id="L175">			BundleEntryRequestComponent req = entry.getRequest();</span>
<span class="fc" id="L176">			params.setUserData(BundleEntryRequestComponent.class.getName(), req);</span>
<span class="fc" id="L177">			req.setMethod(HTTPVerb.GET);</span>
<span class="fc" id="L178">			req.setUrl(request);</span>
		}
		// Always add the search translation to params.
<span class="fc" id="L181">		params.addParameter(&quot;_search&quot;, request);</span>
<span class="fc" id="L182">		return b;</span>
	}

	private String getSearchRequest(Segment seg, String[] parameters) {
<span class="fc" id="L186">		StringBuilder request = null;</span>
<span class="fc" id="L187">		request = new StringBuilder(&quot;/fhir/&quot;);</span>
<span class="fc" id="L188">		request.append(parameters[3]).append(&quot;?&quot;);</span>
<span class="pc bpc" id="L189" title="1 of 4 branches missed.">		for (int i = 3, offset = 4; i &lt;= seg.numFields() &amp;&amp; offset &lt; parameters.length; i++, offset += 4) {</span>
<span class="fc" id="L190">			Type[] types = V2Utils.getFields(seg, i); // Get the fields</span>
<span class="fc bfc" id="L191" title="All 2 branches covered.">			for (Type t : types) {</span>
<span class="fc" id="L192">				String fhirType = parameters[offset + 3];</span>
<span class="fc" id="L193">				t = adjustIfVaries(t, parameters[offset + 1]);</span>
<span class="fc" id="L194">				org.hl7.fhir.r4.model.Type converted = DatatypeConverter.convert(fhirType, t, null);</span>
<span class="fc" id="L195">				addQueryParameter(request, params, parameters[offset + 2], converted);</span>
			}
		}
		// Remove any trailing ? or &amp;
<span class="fc" id="L199">		request.setLength(request.length() - 1);</span>
<span class="fc" id="L200">		return request.toString();</span>
	}
	
	private Boolean isResponse() {
<span class="pc bpc" id="L204" title="1 of 4 branches missed.">		if (mh != null &amp;&amp; mh.getMeta().hasTag()) {</span>
<span class="pc bpc" id="L205" title="1 of 6 branches missed.">			if (mh.getMeta().getTag().stream().anyMatch(c -&gt; c.hasCode() &amp;&amp; &quot;QBP&quot;.equals(c.getCode()))) {</span>
<span class="fc" id="L206">				return true;</span>
<span class="pc bpc" id="L207" title="3 of 6 branches missed.">			} else if (mh.getMeta().getTag().stream().anyMatch(c -&gt; c.hasCode() &amp;&amp; &quot;RSP&quot;.equals(c.getCode()))) {</span>
<span class="fc" id="L208">				return false;</span>
			}
		}
<span class="fc" id="L211">		return null; // NOSONAR: null = unknown</span>
	}

	/**
	 * Some segments can have varying field types, for example, QPD.  This method
	 * allows the field values to be adjusted to the appropriate V2 type.
	 *  
	 * @param t	The type to adjust.
	 * @param typeName The name of the field type to adjust to.
	 * @return	The adjusted type if adjustment is needed, otherwise the original type.
	 */
	private Type adjustIfVaries(Type t, String typeName) {
<span class="pc bpc" id="L223" title="1 of 2 branches missed.">		if (t instanceof Varies v) {</span>
<span class="fc" id="L224">			t = v.getData();</span>
		}
<span class="fc bfc" id="L226" title="All 2 branches covered.">		if (t instanceof GenericComposite) {</span>
			// Well, this is unfortunate, we need to do some classloading shenanigans.
<span class="fc" id="L228">			t = convertTo(t, typeName);</span>
		}
<span class="fc" id="L230">		return t;</span>
	}

	private Type convertTo(Type t, String typeName) {
<span class="fc" id="L234">		Class&lt;? extends Type&gt; target = resolve(&quot;ca.uhn.hl7v2.model.v281.datatype&quot;, typeName);</span>
<span class="pc bpc" id="L235" title="1 of 2 branches missed.">		if (target == null) {</span>
<span class="nc" id="L236">			target = resolve(&quot;ca.uhn.hl7v2.model.v251.datatype&quot;, typeName);</span>
		}
		try {
<span class="fc" id="L239">			Type newType = target.getDeclaredConstructor(Message.class).newInstance(t.getMessage());</span>
<span class="fc" id="L240">			newType.parse(t.encode());</span>
<span class="fc" id="L241">			return newType;</span>
<span class="nc" id="L242">		} catch (InstantiationException | IllegalAccessException | IllegalArgumentException | InvocationTargetException</span>
				| NoSuchMethodException | SecurityException e) {
<span class="nc" id="L244">			log.warn(&quot;Cannot contruct new &quot; + target.getClass().getName());</span>
<span class="nc" id="L245">			return t;</span>
<span class="nc" id="L246">		} catch (HL7Exception e) {</span>
<span class="nc" id="L247">			log.warn(&quot;Cannot parse &quot; + t + &quot; into &quot; + target.getClass().getName());</span>
<span class="nc" id="L248">			return t;</span>
		}
	}
	
	Class&lt;? extends Type&gt; resolve(String packageName, String typeName) {
<span class="fc" id="L253">		String className = packageName + &quot;.&quot; + typeName;</span>
		try {
			@SuppressWarnings(&quot;unchecked&quot;)
<span class="fc" id="L256">			Class&lt;? extends Type&gt; clazz = (Class&lt;? extends Type&gt;) Type.class.getClassLoader().loadClass(className);</span>
<span class="fc" id="L257">			return clazz;</span>
<span class="nc" id="L258">		} catch (ClassNotFoundException e1) {</span>
<span class="nc" id="L259">			log.warn(&quot;Cannot resolve &quot; + className);</span>
<span class="nc" id="L260">			return null;</span>
		}
	}

	private void addQueryParameter(  // NOSONAR: Big switch OK
		StringBuilder request, 
		Parameters params, 
		String name, 
		org.hl7.fhir.r4.model.Type converted
	) {
<span class="pc bpc" id="L270" title="1 of 2 branches missed.">		if (converted == null) {</span>
<span class="nc" id="L271">			return;</span>
		}
<span class="fc" id="L273">		boolean used = false;</span>
<span class="pc bpc" id="L274" title="3 of 8 branches missed.">		switch (converted.getClass().getSimpleName()) {</span>
		case &quot;Address&quot;:
<span class="fc" id="L276">			Address addr = (Address) converted;</span>
<span class="fc bfc" id="L277" title="All 2 branches covered.">			for (StringType line: addr.getLine()) {</span>
<span class="fc" id="L278">				appendParameter(request, line, name);</span>
<span class="fc" id="L279">			}</span>
<span class="fc" id="L280">			used = addParam(request, addr.getCity(), IzQuery.PATIENT_ADDRESS_CITY);</span>
<span class="fc" id="L281">			used |= addParam(request, addr.getState(), IzQuery.PATIENT_ADDRESS_STATE);</span>
<span class="fc" id="L282">			used |= addParam(request, addr.getPostalCode(), IzQuery.PATIENT_ADDRESS_POSTAL);</span>
<span class="fc" id="L283">			used |= addParam(request, addr.getCountry(), IzQuery.PATIENT_ADDRESS_COUNTRY);</span>
<span class="fc" id="L284">			break;</span>
		case &quot;HumanName&quot;:
<span class="fc" id="L286">			HumanName hn = (HumanName) converted;</span>
<span class="fc bfc" id="L287" title="All 2 branches covered.">			if (name.equals(IzQuery.PATIENT_MOTHERS_MAIDEN_NAME)) {</span>
<span class="fc" id="L288">				used = addParam(request, hn.getFamily(), IzQuery.PATIENT_MOTHERS_MAIDEN_NAME); </span>
				// support multiple values for given
<span class="fc bfc" id="L290" title="All 2 branches covered.">				for (StringType given : hn.getGiven()) {</span>
<span class="fc" id="L291">					used |= appendParameter(request, given, IzQuery.PATIENT_MOTHERS_MAIDEN_NAME + &quot;-given&quot;);</span>
<span class="fc" id="L292">				}</span>
<span class="fc" id="L293">				used |= addParam(request, hn.getSuffixAsSingleString(), IzQuery.PATIENT_MOTHERS_MAIDEN_NAME + &quot;-suffix&quot;);</span>
			} else {
<span class="fc" id="L295">				used = addParam(request, hn.getFamily(), IzQuery.PATIENT_NAME_FAMILY); </span>
				// support multiple values for given
<span class="fc bfc" id="L297" title="All 2 branches covered.">				for (StringType given : hn.getGiven()) {</span>
<span class="fc" id="L298">					used |= appendParameter(request, given, IzQuery.PATIENT_NAME_GIVEN);</span>
<span class="fc" id="L299">				}</span>
<span class="fc" id="L300">				used |= addParam(request, hn.getSuffixAsSingleString(), IzQuery.PATIENT_NAME_SUFFIX);</span>
			}
<span class="fc" id="L302">			break;</span>
		case &quot;Identifier&quot;:
<span class="fc" id="L304">			Identifier ident = (Identifier) converted;</span>
<span class="fc bfc" id="L305" title="All 2 branches covered.">			String value = ident.hasSystem() ? ident.getSystem() + &quot;|&quot; : &quot;&quot;;</span>
<span class="pc bpc" id="L306" title="1 of 2 branches missed.">			if (ident.hasValue()) {</span>
<span class="fc" id="L307">				value += ident.getValue();</span>
			}
<span class="fc" id="L309">			used = addParam(request, value, name);</span>
<span class="fc" id="L310">			break;</span>
		case &quot;DateType&quot;:
<span class="fc" id="L312">			DateType dt = new DateType(((BaseDateTimeType)converted).getValue());</span>
<span class="fc" id="L313">			used = addParam(request, dt.asStringValue(), name);</span>
<span class="fc" id="L314">			break;</span>
		case &quot;ContactPoint&quot;:
<span class="nc" id="L316">			ContactPoint cp = (ContactPoint)converted;</span>
<span class="nc bnc" id="L317" title="All 4 branches missed.">			if (!cp.hasSystem() || cp.getSystem().toString().equals(name)) {</span>
<span class="nc" id="L318">				used = addParam(request, cp.getValue(), name);</span>
			}
			break;
		case &quot;StringType&quot;:
<span class="nc" id="L322">			StringType string = (StringType)converted;</span>
<span class="nc" id="L323">			used = addParam(request, string.asStringValue(), name);</span>
<span class="nc" id="L324">			break;</span>
		case &quot;CodeType&quot;:
<span class="fc" id="L326">			CodeType code = (CodeType)converted;</span>
<span class="fc" id="L327">			used = addParam(request, code.asStringValue(), name);</span>
<span class="fc" id="L328">			break;</span>
		default:
			break;
		}
<span class="pc bpc" id="L332" title="1 of 2 branches missed.">		if (used) {</span>
<span class="fc" id="L333">			params.addParameter().setName(name).setValue(converted);</span>
		}
<span class="fc" id="L335">	}</span>
	
	private boolean appendParameter(StringBuilder request, StringType value, String name) {
<span class="fc" id="L338">		return addParam(request, value.asStringValue(), name);</span>
	}
	private boolean addParam(StringBuilder request, String value, String name) {
<span class="fc bfc" id="L341" title="All 2 branches covered.">		if (!StringUtils.isBlank(value)) {</span>
<span class="fc" id="L342">			request</span>
<span class="fc" id="L343">				.append(name)</span>
<span class="fc" id="L344">				.append(&quot;=&quot;)</span>
<span class="fc" id="L345">				.append(URLEncoder.encode(value.trim(), StandardCharsets.UTF_8))</span>
<span class="fc" id="L346">				.append(&quot;&amp;&quot;);</span>
<span class="fc" id="L347">			return true;</span>
		}
<span class="fc" id="L349">		return false;</span>
	}

	private String[] getQueryParameters(CodeableConcept queryName) {
<span class="fc bfc" id="L353" title="All 2 branches covered.">		for (String[] names: v2QueryNames) {</span>
<span class="fc bfc" id="L354" title="All 2 branches covered.">			if (queryName.getCoding().stream().anyMatch(coding -&gt; codingMatches(coding, names))) {</span>
<span class="fc" id="L355">				return names;</span>
			}
		}
<span class="fc" id="L358">		return new String[0];</span>
	}
	
	boolean codingMatches(Coding coding, String[] names) {
<span class="pc bpc" id="L362" title="1 of 4 branches missed.">		return StringUtils.isBlank(names[0]) || names[0].equals(coding.getCode());  </span>
	}

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.13.202504020838</span></div></body></html>